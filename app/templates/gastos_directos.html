{% extends "base.html" %}
{% block title %}Gastos Directos - SOMYL{% endblock %}

{% block content %}
<style>
  /* Estilos modernos para gastos directos */
  .modern-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .modern-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .form-section {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }

  .form-section:last-child {
    border-bottom: none;
  }

  .section-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-title i {
    color: #667eea;
  }

  .form-control-modern, .form-select-modern {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .form-control-modern:focus, .form-select-modern:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    background: white;
  }

  .btn-modern {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
  }

  .btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s ease;
  }

  .btn-modern:hover::before {
    left: 100%;
  }

  .btn-modern:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .btn-primary-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-success-modern {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
  }

  .btn-danger-modern {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    color: white;
  }

  .btn-secondary-modern {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
  }

  .gastos-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
  }

  .gastos-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    font-weight: 600;
    padding: 1rem;
    border: none;
    text-align: center;
  }

  .gastos-table td {
    padding: 0.75rem 1rem;
    border: none;
    border-bottom: 1px solid #f1f3f4;
    text-align: center;
    vertical-align: middle;
  }

  .gastos-table tbody tr {
    transition: all 0.2s ease;
  }

  .gastos-table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
  }

  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .stats-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.3;
  }

  .input-group-modern {
    position: relative;
  }

  .input-group-modern .form-control-modern {
    padding-right: 3rem;
  }

  .input-group-modern .input-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    z-index: 3;
  }

  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .alert-modern {
    border: none;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin: 1rem 0;
    font-weight: 500;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    animation: slideInRight 0.5s ease-out;
  }

  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .project-selector-container {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(102, 126, 234, 0.1);
  }

  .hidden-form {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.5s ease;
  }

  .shown-form {
    max-height: 500px;
    opacity: 1;
  }
</style>

<!-- Header con título -->
<h1 class="titulo-modulo titulo-modulo-con-icono">
  <span class="icono-modulo">💰</span>
  Gastos Directos
</h1>

<!-- Selector de proyecto -->
<div class="modern-card">
  <div class="project-selector-container">
    <div class="section-title">
      <i class="bi bi-building"></i>
      Seleccionar Proyecto
    </div>
    <select id="proyecto" class="form-select form-select-modern" required>
      <option value="">Seleccione un proyecto...</option>
      {% for p in proyectos %}
        <option value="{{ p.id }}">{{ p.proyecto }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- Formulario de gastos (oculto inicialmente) -->
<div id="form-container" class="modern-card hidden-form">
  <div class="form-section">
    <div class="section-title">
      <i class="bi bi-plus-circle"></i>
      Agregar Nuevo Gasto
    </div>
    
    <div class="row g-3">
      <div class="col-md-3">
        <label for="item" class="form-label">Ítem</label>
        <select id="item" class="form-select form-select-modern" required>
          <option value="">Seleccione ítem...</option>
          {% for i in items %}
            <option value="{{ i.id }}">{{ i.tipo }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-4">
        <label for="descripcion" class="form-label">Descripción</label>
        <div class="input-group-modern">
          <input type="text" id="descripcion" class="form-control form-control-modern" 
                 placeholder="Descripción del gasto..." maxlength="255">
          <i class="bi bi-chat-text input-icon"></i>
        </div>
      </div>
      
      <div class="col-md-2">
        <label for="mes" class="form-label">Mes</label>
        <select id="mes" class="form-select form-select-modern" required>
          <option value="">Mes...</option>
          {% for m in meses %}
            <option value="{{ m }}">{{ m }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-2">
        <label for="monto" class="form-label">Monto (CLP)</label>
        <div class="input-group-modern">
          <input type="text" id="monto" class="form-control form-control-modern" 
                 placeholder="0" data-tipo="moneda">
          <i class="bi bi-currency-dollar input-icon"></i>
        </div>
      </div>
      
      <div class="col-md-1 d-flex align-items-end">
        <button id="agregar-gasto" class="btn btn-primary-modern btn-modern w-100">
          <i class="bi bi-plus"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Resumen de gastos -->
<div id="stats-container" class="hidden-form">
  <div class="row">
    <div class="col-md-4">
      <div class="stats-card">
        <div class="stats-value" id="total-gastos">0</div>
        <div class="stats-label">Gastos Agregados</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stats-card">
        <div class="stats-value" id="total-monto">$0</div>
        <div class="stats-label">Monto Total</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stats-card">
        <div class="stats-value" id="proyecto-nombre">-</div>
        <div class="stats-label">Proyecto Seleccionado</div>
      </div>
    </div>
  </div>
</div>

<!-- Tabla de gastos -->
<div id="tabla-container" class="modern-card hidden-form">
  <div class="form-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="section-title">
        <i class="bi bi-table"></i>
        Gastos Agregados
      </div>
      <div class="d-flex gap-2">
        <button id="limpiar-todo" class="btn btn-secondary-modern btn-modern btn-sm">
          <i class="bi bi-trash me-1"></i>Limpiar Todo
        </button>
        <button id="guardar-todo" class="btn btn-success-modern btn-modern" disabled>
          <i class="bi bi-save me-1"></i>Guardar Gastos
        </button>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table gastos-table" id="tabla-gastos">
        <thead>
          <tr>
            <th><i class="bi bi-tag me-1"></i>Ítem</th>
            <th><i class="bi bi-chat-text me-1"></i>Descripción</th>
            <th><i class="bi bi-calendar me-1"></i>Mes</th>
            <th><i class="bi bi-currency-dollar me-1"></i>Monto</th>
            <th><i class="bi bi-gear me-1"></i>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr class="empty-state" id="empty-row">
            <td colspan="5">
              <i class="bi bi-inbox"></i>
              <div>No hay gastos agregados</div>
              <small>Agregue gastos usando el formulario de arriba</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Área de mensajes -->
<div id="msg-container"></div>

<!-- JavaScript moderno para gastos directos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Variables globales
  const proyectos = {{ proyectos|tojson }};
  const items = {{ items|tojson }};
  let gastos = [];
  
  // Elementos del DOM
  const proyectoSelect = document.getElementById('proyecto');
  const formContainer = document.getElementById('form-container');
  const statsContainer = document.getElementById('stats-container');
  const tablaContainer = document.getElementById('tabla-container');
  const itemSelect = document.getElementById('item');
  const descripcionInput = document.getElementById('descripcion');
  const mesSelect = document.getElementById('mes');
  const montoInput = document.getElementById('monto');
  const agregarBtn = document.getElementById('agregar-gasto');
  const guardarBtn = document.getElementById('guardar-todo');
  const limpiarBtn = document.getElementById('limpiar-todo');
  const tablaBody = document.querySelector('#tabla-gastos tbody');
  const emptyRow = document.getElementById('empty-row');
  
  // Event listeners
  proyectoSelect.addEventListener('change', onProyectoChange);
  agregarBtn.addEventListener('click', onAgregarGasto);
  guardarBtn.addEventListener('click', onGuardarTodo);
  limpiarBtn.addEventListener('click', onLimpiarTodo);
  montoInput.addEventListener('input', formatearMonto);
  montoInput.addEventListener('blur', onMontoBlur);
  montoInput.addEventListener('focus', onMontoFocus);
  
  // Validación en tiempo real
  [itemSelect, mesSelect, montoInput].forEach(input => {
    input.addEventListener('change', validarFormulario);
    input.addEventListener('input', validarFormulario);
  });
  
  function onProyectoChange() {
    const proyectoId = this.value;
    const proyectoNombre = proyectos.find(p => p.id == proyectoId)?.proyecto || '-';
    
    if (proyectoId) {
      mostrarFormulario();
      actualizarStats();
      document.getElementById('proyecto-nombre').textContent = proyectoNombre;
    } else {
      ocultarFormulario();
      resetearFormulario();
    }
  }
  
  function mostrarFormulario() {
    formContainer.classList.remove('hidden-form');
    formContainer.classList.add('shown-form', 'fade-in');
    statsContainer.classList.remove('hidden-form');
    statsContainer.classList.add('shown-form', 'fade-in');
    tablaContainer.classList.remove('hidden-form');
    tablaContainer.classList.add('shown-form', 'fade-in');
  }
  
  function ocultarFormulario() {
    [formContainer, statsContainer, tablaContainer].forEach(container => {
      container.classList.add('hidden-form');
      container.classList.remove('shown-form', 'fade-in');
    });
  }
  
  function onAgregarGasto(e) {
    e.preventDefault();
    
    const itemId = itemSelect.value;
    const descripcion = descripcionInput.value.trim();
    const mes = mesSelect.value;
    const montoRaw = montoInput.value.replace(/\D/g, '');
    
    if (!validarCampos(itemId, mes, montoRaw)) return;
    
    const itemNombre = items.find(i => i.id == itemId)?.tipo || '';
    
    const nuevoGasto = {
      item_id: itemId,
      item_nombre: itemNombre,
      descripcion: descripcion || 'Sin descripción',
      mes: mes,
      monto: parseInt(montoRaw)
    };
    
    gastos.push(nuevoGasto);
    renderizarTabla();
    limpiarFormulario();
    actualizarStats();
    validarFormulario();
    
    mostrarMensaje('Gasto agregado correctamente', 'success');
  }
  
  function validarCampos(itemId, mes, montoRaw) {
    if (!itemId) {
      mostrarMensaje('Debe seleccionar un ítem', 'danger');
      itemSelect.focus();
      return false;
    }
    
    if (!mes) {
      mostrarMensaje('Debe seleccionar un mes', 'danger');
      mesSelect.focus();
      return false;
    }
    
    if (!montoRaw || parseInt(montoRaw) <= 0) {
      mostrarMensaje('Debe ingresar un monto válido', 'danger');
      montoInput.focus();
      return false;
    }
    
    return true;
  }
  
  function renderizarTabla() {
    // Limpiar tabla
    tablaBody.innerHTML = '';
    
    if (gastos.length === 0) {
      tablaBody.appendChild(emptyRow);
      guardarBtn.disabled = true;
      return;
    }
    
    gastos.forEach((gasto, index) => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td><span class="badge bg-primary">${gasto.item_nombre}</span></td>
        <td>${gasto.descripcion}</td>
        <td><span class="badge bg-secondary">${gasto.mes}</span></td>
        <td><strong class="text-success">$${gasto.monto.toLocaleString('es-CL')}</strong></td>
        <td>
          <button class="btn btn-danger-modern btn-modern btn-sm" onclick="eliminarGasto(${index})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      fila.classList.add('fade-in');
      tablaBody.appendChild(fila);
    });
    
    guardarBtn.disabled = false;
  }
  
  function actualizarStats() {
    const totalGastos = gastos.length;
    const totalMonto = gastos.reduce((sum, gasto) => sum + gasto.monto, 0);
    
    document.getElementById('total-gastos').textContent = totalGastos;
    document.getElementById('total-monto').textContent = `$${totalMonto.toLocaleString('es-CL')}`;
  }
  
  function limpiarFormulario() {
    itemSelect.value = '';
    descripcionInput.value = '';
    mesSelect.value = '';
    montoInput.value = '';
    validarFormulario();
  }
  
  function resetearFormulario() {
    gastos = [];
    limpiarFormulario();
    renderizarTabla();
    actualizarStats();
  }
  
  function validarFormulario() {
    const itemId = itemSelect.value;
    const mes = mesSelect.value;
    const monto = montoInput.value.replace(/\D/g, '');
    
    const esValido = itemId && mes && monto && parseInt(monto) > 0;
    
    agregarBtn.disabled = !esValido;
    agregarBtn.classList.toggle('btn-primary-modern', esValido);
    agregarBtn.classList.toggle('btn-secondary-modern', !esValido);
  }
  
  function formatearMonto() {
    let valor = this.value.replace(/\D/g, '');
    if (valor) {
      this.value = parseInt(valor).toLocaleString('es-CL');
    }
  }
  
  function onMontoBlur() {
    let valor = this.value.replace(/\D/g, '');
    if (valor) {
      this.value = '$' + parseInt(valor).toLocaleString('es-CL');
    }
  }
  
  function onMontoFocus() {
    this.value = this.value.replace(/\D/g, '');
  }
  
  function onGuardarTodo() {
    const proyectoId = proyectoSelect.value;
    
    if (!proyectoId || gastos.length === 0) {
      mostrarMensaje('No hay gastos para guardar', 'warning');
      return;
    }
    
    // Mostrar loading
    guardarBtn.disabled = true;
    guardarBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
    
    fetch('{{ url_for("gastos_directos.guardar_gastos_directos") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ proyecto_id: proyectoId, gastos })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarMensaje(data.message, 'success');
        resetearFormulario();
        proyectoSelect.value = '';
        ocultarFormulario();
      } else {
        mostrarMensaje(data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al guardar los gastos', 'danger');
    })
    .finally(() => {
      guardarBtn.disabled = false;
      guardarBtn.innerHTML = '<i class="bi bi-save me-1"></i>Guardar Gastos';
    });
  }
  
  function onLimpiarTodo() {
    if (gastos.length === 0) return;
    
    if (confirm('¿Está seguro de que desea limpiar todos los gastos agregados?')) {
      resetearFormulario();
      mostrarMensaje('Gastos limpiados', 'info');
    }
  }
  
  function mostrarMensaje(mensaje, tipo) {
    const container = document.getElementById('msg-container');
    
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-modern`;
    alerta.innerHTML = `
      <i class="bi bi-${getIconForType(tipo)} me-2"></i>
      ${mensaje}
      <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;
    
    container.appendChild(alerta);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
      if (alerta.parentNode) {
        alerta.remove();
      }
    }, 5000);
  }
  
  function getIconForType(tipo) {
    const icons = {
      'success': 'check-circle-fill',
      'danger': 'exclamation-triangle-fill',
      'warning': 'exclamation-circle-fill',
      'info': 'info-circle-fill'
    };
    return icons[tipo] || 'info-circle-fill';
  }
  
  // Función global para eliminar gastos (llamada desde el HTML)
  window.eliminarGasto = function(index) {
    if (confirm('¿Está seguro de que desea eliminar este gasto?')) {
      gastos.splice(index, 1);
      renderizarTabla();
      actualizarStats();
      mostrarMensaje('Gasto eliminado', 'info');
    }
  };
  
  // Inicialización
  validarFormulario();
  actualizarStats();
});
</script>

{% endblock %}