{% extends 'base.html' %}

{% block title %}Informe de Pagos - SOMYL{% endblock %}

{% block content %}
<style>
  /* Estilos modernos para la tabla de pagos */
  .payment-table {
    font-size: 0.85rem;
    border-collapse: collapse;
    width: 100%;
  }
  
  .payment-table th, .payment-table td {
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
  }
  
  .payment-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 600;
    font-size: 0.75rem;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .payment-table tbody tr {
    transition: all 0.2s ease;
  }
  
  .payment-table tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
    transform: scale(1.002);
  }
  
  /* Filas pagadas */
  .row-paid {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    border-left: 4px solid #28a745;
  }
  
  .row-paid:hover {
    background: linear-gradient(135deg, #c3e6cb 0%, #b1dfbb 100%) !important;
  }
  
  /* Cards modernos */
  .modern-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .modern-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  
  .summary-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .summary-header {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }
  
  .project-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }
  
  .project-list li {
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .project-list li:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .project-name {
    font-weight: 500;
    color: #495057;
  }
  
  .project-amount {
    font-weight: 600;
    color: #dc3545;
  }
  
  .total-summary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 0.8rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  /* Botones modernos */
  .btn-modern {
    border-radius: 10px;
    font-weight: 500;
    padding: 0.6rem 1.5rem;
    transition: all 0.2s ease;
    border: none;
  }
  
  .btn-modern:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .btn-primary-modern {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
  }
  
  .btn-secondary-modern {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
  }
  
  /* Input de fecha mejorado */
  .date-input {
    border: 1px solid #ced4da;
    border-radius: 6px;
    padding: 0.375rem 0.5rem;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    width: 100%;
  }
  
  .date-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
  }
  
  /* Anchos de columnas espec√≠ficos */
  .col-fecha-op { width: 85px; }
  .col-opago { width: 80px; }
  .col-proveedor { width: 150px; }
  .col-detalle { width: 200px; }
  .col-factura { width: 70px; min-width: 40px; max-width: 120px; }
  /* Estilos para el resizer de columnas */
  .payment-table th { position: relative; }
  .resizer {
    position: absolute;
    right: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: col-resize;
    user-select: none;
    z-index: 10;
    background: transparent;
  }
  .resizer:hover {
    background: #007bff22;
  }

  .col-total-pago { width: 100px; text-align: right; }
  .col-fecha-pago { width: 130px; }
  .col-proyecto { width: 120px; }
  .col-orden-compra { width: 100px; }
  .col-condicion { width: 120px; }
  .col-cuenta { width: 100px; }
  .col-vencimiento { width: 100px; }
  .col-fecha-factura { width: 100px; }
  
  /* Responsive mejoras */
  .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .table-responsive {
    max-height: 70vh;
    overflow-x: auto;
    overflow-y: auto;
  }
  
  /* Stats indicators */
  .stats-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .stats-pending { background-color: #dc3545; }
  .stats-paid { background-color: #28a745; }
  
  /* Mejoras para b√∫squeda y filtros */
  .search-highlight {
    background-color: #fff3cd !important;
    transition: background-color 0.3s ease;
  }
  
  .filter-badge {
    position: relative;
    overflow: hidden;
  }
  
  .filter-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
  }
  
  .filter-badge:hover::before {
    left: 100%;
  }
  
  /* Animaciones para las tarjetas de estad√≠sticas */
  .card {
    transition: all 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  /* Input de b√∫squeda mejorado */
  .input-group .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
  }
  
  /* Indicador de cambios no guardados */
  .date-input.changed {
    border-color: #28a745 !important;
    border-width: 2px !important;
    background-color: #f8fff9;
  }
  
  /* Efectos de hover mejorados para la tabla */
  .payment-table tbody tr {
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .payment-table tbody tr:hover {
    background-color: rgba(0,123,255,0.08);
    transform: scale(1.001);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* Spinner de carga para filtros */
  .loading-spinner {
    display: none;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Responsive improvements */
  @media (max-width: 768px) {
    .payment-table {
      font-size: 0.75rem;
    }
    
    .payment-table th,
    .payment-table td {
      padding: 0.3rem;
    }
    
    .summary-card {
      margin-bottom: 1rem;
    }
  }

</style>

<!-- Header con t√≠tulo y controles -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="titulo-modulo titulo-modulo-con-icono mb-0">
    <span class="icono-modulo">üí∞</span>
    Informe de Pagos Somyl.
  </h1>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
      <i class="bi bi-x-circle me-1"></i>Limpiar
    </button>
  </div>
</div>

<!-- B√∫squeda r√°pida -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="input-group mb-2">
      <span class="input-group-text">
        <i class="bi bi-search"></i>
      </span>
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar por proveedor, detalle, factura o proyecto...">
    </div>
    <div class="input-group">
      <span class="input-group-text">
        <i class="bi bi-hash"></i>
      </span>
      <input type="text" id="ordenPagoInput" class="form-control" placeholder="Buscar por N¬∞ Orden de Pago...">
    </div>
  </div>
  <div class="col-md-6">
    <div class="d-flex justify-content-end gap-2">
      <select id="estadoFilter" class="form-select form-select-sm" style="width: auto;">
        <option value="">Todos los estados</option>
        <option value="pendiente">Pendientes</option>
        <option value="pagado">Pagados</option>
      </select>
      <select id="proyectoFilter" class="form-select form-select-sm" style="width: auto;">
        <option value="">Todos los proyectos</option>
        {% for proyecto in proyectos_unicos %}
        <option value="{{ proyecto }}">{{ proyecto }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<!-- Card de resumen de proyectos pendientes -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="row">
      <div class="col-md-3">
        <div class="card border-0 bg-light">
          <div class="card-body text-center">
            <h5 class="card-title text-primary">{{ pagos|length }}</h5>
            <p class="card-text text-muted mb-0">Total √ìrdenes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 bg-success bg-opacity-10">
          <div class="card-body text-center">
            <h5 class="card-title text-success">{{ pagos|selectattr('fecha_pago')|list|length }}</h5>
            <p class="card-text text-muted mb-0">Pagadas</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 bg-danger bg-opacity-10">
          <div class="card-body text-center">
            <h5 class="card-title text-danger">{{ pagos|rejectattr('fecha_pago')|list|length }}</h5>
            <p class="card-text text-muted mb-0">Pendientes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 bg-warning bg-opacity-10">
          <div class="card-body text-center">
            <h5 class="card-title text-warning">${{ "{:,.0f}".format(total_pendiente).replace(',', '.') }}</h5>
            <p class="card-text text-muted mb-0">Monto Pendiente</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="summary-card">
      {% set pending = {} %}
      {% for p in pagos %}
        {% if not p.fecha_pago %}
          {% set _ = pending.update({p.proyecto: (pending.get(p.proyecto, 0) + p.total_pago)}) %}
        {% endif %}
      {% endfor %}
      <div class="summary-header mb-3">
        <span class="stats-indicator stats-pending"></span>
        Proyectos Pendientes de Pago
      </div>
      <ul class="project-list">
        {% for proyecto, monto in pending.items() %}
        <li>
          <span class="project-name">{{ proyecto }}</span>
          <span class="project-amount">${{ '{:,.0f}'.format(monto).replace(',', '.') }}</span>
        </li>
        {% endfor %}
      </ul>
      {% set grand_total = pending.values()|sum %}
      <div class="total-summary mt-4">
        Total Pendiente: ${{ '{:,.0f}'.format(total_pendiente).replace(',', '.') }}
      </div>
    </div>
  </div>
</div>
<!-- Formulario principal con tabla -->
<div class="modern-card">
  <form method="POST" action="{{ url_for('pagos.update_pagos') }}">
    <!-- Botones de acci√≥n -->
    <div class="p-3 border-bottom" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        {% if puede_editar %}
        <button type="submit" class="btn btn-primary-modern btn-modern">
          <i class="bi bi-floppy me-2"></i>Guardar Fechas de Pago
        </button>
        {% endif %}
        <a href="{{ url_for('pagos.export_pagos') }}" class="btn btn-secondary-modern btn-modern">
          <i class="bi bi-file-earmark-excel me-2"></i>Exportar a Excel
        </a>
        <div class="ms-auto d-flex align-items-center">
          <span class="badge bg-light text-dark me-2">
            <span class="stats-indicator stats-paid"></span>
            {{ pagos|selectattr('fecha_pago')|list|length }} Pagados
          </span>
          <span class="badge bg-light text-dark">
            <span class="stats-indicator stats-pending"></span>
            {{ pagos|rejectattr('fecha_pago')|list|length }} Pendientes
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla responsiva -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="payment-table">
          <thead>
            <tr>
              <th class="col-fecha-op">FECHA<br>OP</th>
              <th class="col-opago">O.PAGO</th>
              <th class="col-proveedor">PROVEEDOR</th>
              <th class="col-detalle">DETALLE O.PAGO</th>
              <th class="col-factura">FACTURA<br>ASOCIADA</th>
              <th class="col-total-pago">TOTAL<br>PAGO</th>
              <th class="col-fecha-pago">FECHA DE<br>PAGO</th>
              <th class="col-proyecto">PROYECTO</th>
              <th class="col-orden-compra">O.COMPRA</th>
              <th class="col-condicion">CONDICI√ìN<br>PAGO</th>
              <th class="col-cuenta">CTA CTE<br>PROVEEDOR</th>
              <th class="col-vencimiento">VENCIMIENTO<br>FAC.</th>
              <th class="col-fecha-factura">FECHA<br>FAC.</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pagos %}
            <tr class="{% if p.fecha_pago %}row-paid{% endif %}" data-orden="{{ p.orden_numero }}">
              <td class="col-fecha-op">
                <small class="text-muted">{{ p.fecha }}</small>
              </td>
              <td class="col-opago">
                <strong>{{ p.orden_numero }}</strong>
                <input type="hidden" name="orden_numero[]" value="{{ p.orden_numero }}">
              </td>
              <td class="col-proveedor">
                <div class="text-truncate" style="max-width: 140px;" title="{{ p.proveedor_nombre }}">
                  {{ p.proveedor_nombre }}
                </div>
              </td>
              <td class="col-detalle">
                <div class="text-truncate" style="max-width: 180px;" title="{{ p.detalle_compra }}">
                  {{ p.detalle_compra }}
                </div>
              </td>
              <td class="col-factura">
                {% if p.factura %}
                  <span class="badge bg-primary">{{ p.factura }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-total-pago">
                <strong class="text-{% if p.fecha_pago %}success{% else %}danger{% endif %}">
                  ${{ "{:,.0f}".format(p.total_pago).replace(',', '.') }}
                </strong>
              </td>
              <td class="col-fecha-pago">
                <input type="date"
                       name="fecha_pago[]"
                       class="date-input"
                       value="{{ p.fecha_pago or '' }}"
                       min="1900-01-01"
                       max="{{ fecha_maxima }}"
                       title="Fecha de pago para orden {{ p.orden_numero }}"
                       {% if not puede_editar %}disabled{% endif %}>
              </td>
              <td class="col-proyecto">
                <span class="badge bg-secondary">{{ p.proyecto }}</span>
              </td>
              <td class="col-orden-compra">
                {% if p.orden_compra %}
                  {{ p.orden_compra }}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-condicion">
                <small>{{ p.condicion_pago or '-' }}</small>
              </td>
              <td class="col-cuenta">
                <small>{{ p.cuenta or '-' }}</small>
              </td>
              <td class="col-vencimiento">
                {% if p.vencimiento %}
                  <small class="text-muted">{{ p.vencimiento }}</small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-fecha-factura">
                {% if p.fecha_factura %}
                  <small class="text-muted">{{ p.fecha_factura }}</small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Footer con informaci√≥n adicional -->
    <div class="p-3 border-top" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div class="row">
        <div class="col-md-6">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Total de √≥rdenes: {{ pagos|length }}
          </small>
        </div>
        <div class="col-md-6 text-end">
          <small class="text-muted">
            {% set monto_pagado = pagos|selectattr('fecha_pago')|sum(attribute='total_pago') %}
            Pagado: ${{ "{:,.0f}".format(monto_pagado).replace(',', '.') }} | 
            Pendiente: ${{ "{:,.0f}".format(total_pendiente).replace(',', '.') }}
          </small>
        </div>
      </div>
    </div>
  </form>
</div>


<!-- Scripts adicionales para mejorar la experiencia -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Referencias a elementos
  const searchInput = document.getElementById('searchInput');
  const estadoFilter = document.getElementById('estadoFilter');
  const proyectoFilter = document.getElementById('proyectoFilter');
  const tableRows = document.querySelectorAll('tbody tr');
  const dateInputs = document.querySelectorAll('.date-input');
  const ordenPagoInput = document.getElementById('ordenPagoInput');

  // Funci√≥n de b√∫squeda y filtrado en tiempo real
  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const estadoValue = estadoFilter.value;
    const proyectoValue = proyectoFilter.value;
    const ordenPagoValue = ordenPagoInput.value.toLowerCase();

    let visibleRows = 0;

    tableRows.forEach(row => {
      const proveedor = row.querySelector('.col-proveedor').textContent.toLowerCase();
      const detalle = row.querySelector('.col-detalle').textContent.toLowerCase();
      const factura = row.querySelector('.col-factura').textContent.toLowerCase();
      const proyecto = row.querySelector('.col-proyecto').textContent.toLowerCase();
      const ordenPago = row.querySelector('.col-opago').textContent.toLowerCase();
      const esPagado = row.classList.contains('row-paid');

      // Verificar filtros
      let mostrarFila = true;

      // Filtro de b√∫squeda
      if (searchTerm && !proveedor.includes(searchTerm) && 
          !detalle.includes(searchTerm) && !factura.includes(searchTerm) && 
          !proyecto.includes(searchTerm)) {
        mostrarFila = false;
      }

      // Filtro de estado
      if (estadoValue === 'pendiente' && esPagado) {
        mostrarFila = false;
      } else if (estadoValue === 'pagado' && !esPagado) {
        mostrarFila = false;
      }

      // Filtro de proyecto
      if (proyectoValue && !proyecto.includes(proyectoValue.toLowerCase())) {
        mostrarFila = false;
      }

      // Filtro por N¬∞ Orden de Pago (coincidencia parcial)
      if (ordenPagoValue && !ordenPago.includes(ordenPagoValue)) {
        mostrarFila = false;
      }

      // Mostrar/ocultar fila
      if (mostrarFila) {
        row.style.display = '';
        visibleRows++;
      } else {
        row.style.display = 'none';
      }
    });

    // Actualizar contador de resultados
    updateResultsCounter(visibleRows);
  }

  // Funci√≥n para actualizar contador de resultados
  function updateResultsCounter(count) {
    let counter = document.getElementById('resultsCounter');
    if (!counter) {
      counter = document.createElement('div');
      counter.id = 'resultsCounter';
      counter.className = 'alert alert-info py-2 px-3 mt-2 mb-0';
      const tableContainer = document.querySelector('.table-container');
      tableContainer.appendChild(counter);
    }

    if (count === tableRows.length) {
      counter.style.display = 'none';
    } else {
      counter.style.display = 'block';
      counter.innerHTML = `<i class="bi bi-info-circle me-2"></i>Mostrando ${count} de ${tableRows.length} √≥rdenes de pago`;
    }
  }

  // Event listeners para filtros en tiempo real
  searchInput.addEventListener('input', filterTable);
  estadoFilter.addEventListener('change', filterTable);
  proyectoFilter.addEventListener('change', filterTable);
  ordenPagoInput.addEventListener('input', filterTable);

  // Destacar filas al cambiar fecha de pago
  dateInputs.forEach(input => {
    input.addEventListener('change', function() {
      const row = this.closest('tr');
      if (this.value) {
        row.classList.add('row-paid');
        this.style.backgroundColor = '#d4edda';
      } else {
        row.classList.remove('row-paid');
        this.style.backgroundColor = '';
      }
      // Actualizar filtros despu√©s del cambio
      setTimeout(filterTable, 100);
    });
  });

  // Tooltip para celdas truncadas
  const truncatedCells = document.querySelectorAll('.text-truncate');
  truncatedCells.forEach(cell => {
    cell.addEventListener('mouseenter', function() {
      if (this.scrollWidth > this.clientWidth) {
        this.setAttribute('title', this.textContent);
      }
    });
  });

  // Confirmaci√≥n antes de enviar formulario
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    const changedDates = Array.from(dateInputs).filter(input => input.value && input.style.backgroundColor).length;
    if (changedDates > 0) {
      if (!confirm(`¬øConfirma guardar ${changedDates} fecha(s) de pago?`)) {
        e.preventDefault();
      }
    }
  });

  // Resaltar cambios no guardados
  dateInputs.forEach(input => {
    const originalValue = input.value;
    input.addEventListener('change', function() {
      if (this.value !== originalValue) {
        this.style.borderColor = '#28a745';
        this.style.borderWidth = '2px';
      } else {
        this.style.borderColor = '';
        this.style.borderWidth = '';
      }
    });
  });

  window.limpiarFiltros = function() {
    // Limpiar filtros de la p√°gina actual
    document.getElementById('searchInput').value = '';
    document.getElementById('estadoFilter').value = '';
    document.getElementById('proyectoFilter').value = '';
    ordenPagoInput.value = '';
    filterTable();
    // Recargar p√°gina sin filtros
    window.location.href = window.location.pathname;
  };

  // Exportar datos filtrados (sin cambios)
  window.exportarFiltrados = function() {
    const visibleRows = Array.from(document.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
    if (visibleRows.length === 0) {
      alert('No hay datos para exportar con los filtros actuales.');
      return;
    }
    // Aqu√≠ se podr√≠a implementar la exportaci√≥n de solo los datos filtrados
    console.log('Exportando', visibleRows.length, 'filas filtradas');
  };
});
</script>


{% endblock %}