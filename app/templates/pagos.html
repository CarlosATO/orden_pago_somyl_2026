{% extends 'base.html' %}

{% block title %}Informe de Pagos - SOMYL{% endblock %}

{% block content %}

<!-- Modal para historial de abonos -->
<div class="modal fade" id="abonosModal" tabindex="-1" aria-labelledby="abonosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="abonosModalLabel">Historial de Abonos - OP <span id="modalOrdenNum"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formAbono" class="row g-2 mb-3" onsubmit="return registrarAbono(event)">
          <input type="hidden" id="abonoOrdenNum" name="orden_numero">
          <div class="col-md-3">
            <input type="date" class="form-control form-control-sm" id="abonoFecha" name="fecha_abono" required value="{{ date.today().isoformat() }}">
          </div>
          <div class="col-md-3">
            <input type="number" class="form-control form-control-sm" id="abonoMonto" name="monto_abono" min="1" step="any" placeholder="Monto abono" required>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control form-control-sm" id="abonoObs" name="observacion" maxlength="100" placeholder="Observación">
          </div>
          <div class="col-md-2">
            <button type="submit" id="btnRegistrarAbono" class="btn btn-success btn-sm w-100" disabled>Registrar abono</button>
          </div>
        </form>
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Monto</th>
              <th>Observación</th>
              <th>Usuario</th>
              <th>Registrado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="abonosTableBody">
          </tbody>
        </table>
      </div>
<script>
let abonoEditandoId = null;
function showAbonos(orden_numero) {
  // Actualizar el título del modal con el número de orden
  document.getElementById('modalOrdenNum').textContent = orden_numero;
  document.getElementById('abonoOrdenNum').value = orden_numero;
  
  // Mostrar el modal inmediatamente
  const modalEl = document.getElementById('abonosModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
  
  // Cargar datos de abonos
  fetch(`/pagos/abonos/${orden_numero}`)
    .then(resp => resp.json())
    .then(data => {
      const tableBody = document.getElementById('abonosTableBody');
      tableBody.innerHTML = '';
      
      if (data.success && data.abonos && data.abonos.length > 0) {
        data.abonos.forEach(abono => {
          const row = document.createElement('tr');
          const monto = parseInt(abono.monto_abono || 0);
          const fecha = abono.fecha_abono || '-';
          const obs = (abono.observacion || '').replace(/'/g, '&#39;');
          
          row.innerHTML = `
            <td>${fecha}</td>
            <td>$${monto.toLocaleString('es-CL')}</td>
            <td>${obs}</td>
            <td>${abono.usuario || '-'}</td>
            <td>${abono.created_at ? new Date(abono.created_at).toLocaleDateString('es-CL') : '-'}</td>
            <td>
              <button type="button" class="btn btn-warning btn-sm me-1" onclick="editarAbono(${abono.id}, ${monto}, '${obs}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm" onclick="eliminarAbono(${abono.id}, ${orden_numero})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin abonos registrados</td></tr>';
      }
    })
    .catch(error => {
      console.error('Error al cargar abonos:', error);
      document.getElementById('abonosTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar abonos</td></tr>';
    });
}

function editarAbono(id, monto, observacion) {
  // Buscar la fila que contiene este abono
  const tableBody = document.getElementById('abonosTableBody');
  const rows = tableBody.querySelectorAll('tr');
  
  rows.forEach(row => {
    const editButton = row.querySelector(`button[onclick*="editarAbono(${id}"]`);
    if (editButton) {
      // Reemplazar el contenido de la fila con campos editables
      row.innerHTML = `
        <td><input type="date" id="editFecha" value="" class="form-control form-control-sm"></td>
        <td><input type="number" id="editMonto" value="${monto}" class="form-control form-control-sm" min="1" step="any"></td>
        <td><input type="text" id="editObs" value="${observacion}" class="form-control form-control-sm" maxlength="100"></td>
        <td colspan="2">Editando...</td>
        <td>
          <button type="button" class="btn btn-success btn-sm me-1" onclick="guardarEdicionAbono(${id}, document.getElementById('abonoOrdenNum').value)">
            <i class="bi bi-check"></i>
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="showAbonos(document.getElementById('abonoOrdenNum').value)">
            <i class="bi bi-x"></i>
          </button>
        </td>
      `;
      abonoEditandoId = id;
    }
  });
}

function guardarEdicionAbono(id, orden_numero) {
  const monto = document.getElementById('editMonto').value;
  const obs = document.getElementById('editObs').value;
  
  // Validar que el monto sea válido
  if (!monto || parseFloat(monto) <= 0) {
    alert('El monto debe ser mayor a cero');
    return;
  }
  
  fetch(`/pagos/abonos/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ monto_abono: monto, observacion: obs })
  })
  .then(resp => {
    if (!resp.ok) {
      throw new Error(`HTTP error! status: ${resp.status}`);
    }
    return resp.json();
  })
  .then(data => {
    abonoEditandoId = null;
    if (data.success) {
      // Actualizar solo esta fila en lugar de recargar todo
      showAbonos(orden_numero);
      // Marcar que necesitamos recargar la página al cerrar el modal
      window.needsPageReload = true;
    } else {
      alert('Error: ' + (data.error || 'No se pudo editar abono.'));
    }
  })
  .catch(error => {
    console.error('Error al editar abono:', error);
    alert('Error de conexión al editar el abono. Inténtalo de nuevo.');
    abonoEditandoId = null;
  });
}
function eliminarAbono(id, orden_numero) {
  if (!confirm('¿Seguro que deseas eliminar este abono?')) return;
  
  fetch(`/pagos/abonos/${id}`, { 
    method: 'DELETE',
    headers: {
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    }
  })
    .then(resp => {
      if (!resp.ok) {
        throw new Error(`HTTP error! status: ${resp.status}`);
      }
      return resp.json();
    })
    .then(data => {
      if (data.success) {
        // Eliminar inmediatamente la fila del DOM
        const tableBody = document.getElementById('abonosTableBody');
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
          const deleteButton = row.querySelector(`button[onclick*="eliminarAbono(${id}"]`);
          if (deleteButton) {
            row.remove();
          }
        });
        
        // Verificar si quedan filas, si no, mostrar mensaje
        const remainingRows = tableBody.querySelectorAll('tr');
        if (remainingRows.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin abonos registrados</td></tr>';
        }
        
        // Marcar que necesitamos recargar la página al cerrar el modal
        window.needsPageReload = true;
      } else {
        alert('Error: ' + (data.error || 'No se pudo eliminar abono.'));
      }
    })
    .catch(error => {
      console.error('Error al eliminar abono:', error);
      alert('Error de conexión al eliminar el abono. Inténtalo de nuevo.');
    });
}
function registrarAbono(event) {
  event.preventDefault();
  const abonoInput = document.getElementById('abonoOrdenNum');
  const orden_numero = abonoInput ? abonoInput.value : null;
  if (!orden_numero) {
    alert('Error: No se ha seleccionado una orden de pago.');
    return false;
  }
  const monto = document.getElementById('abonoMonto').value;
  const fecha = document.getElementById('abonoFecha').value;
  const obs = document.getElementById('abonoObs').value;
  fetch(`/pagos/abonos/${orden_numero}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ monto_abono: monto, fecha_abono: fecha, observacion: obs })
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showAbonos(orden_numero);
      document.getElementById('formAbono').reset();
      document.getElementById('btnRegistrarAbono').disabled = true;
      // Marcar que necesitamos recargar la página al cerrar el modal
      window.needsPageReload = true;
      // Cerrar el modal automáticamente
      setTimeout(() => {
        var modalEl = document.getElementById('abonosModal');
        var modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
      }, 500);
    } else {
      alert('Error: ' + (data.error || 'No se pudo registrar abono.'));
    }
  });
  return false;
}

// Agregar event listener para recargar la página cuando se cierre el modal si hubo cambios
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('abonosModal');
  if (modalEl) {
    modalEl.addEventListener('hidden.bs.modal', function () {
      if (window.needsPageReload) {
        window.needsPageReload = false;
        // Recargar la página para actualizar los totales
        window.location.reload();
      }
    });
  }
});
</script>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
</script>
<script>
// Sumar en tiempo real la columna SALDO PENDIENTE y mostrar en el cuadro
// --- INICIO LIMPIEZA SUMA SALDO PENDIENTE ---
// Eliminado: función actualizarSaldoPendienteTotal y eventos relacionados
// --- FIN LIMPIEZA SUMA SALDO PENDIENTE ---
</script>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<style>
  /* Estilos modernos para la tabla de pagos */
  .payment-table {
    font-size: 0.85rem;
    border-collapse: collapse;
    width: 100%;
  }
  
  .payment-table th, .payment-table td {
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
  }
  
  .payment-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 600;
    font-size: 0.75rem;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .payment-table tbody tr {
    transition: all 0.2s ease;
  }
  
  .payment-table tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
    transform: scale(1.002);
  }
  
  /* Filas pagadas */
  .row-paid {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    border-left: 4px solid #28a745;
  }
  
  .row-paid:hover {
    background: linear-gradient(135deg, #c3e6cb 0%, #b1dfbb 100%) !important;
  }
  
  /* Cards modernos */
  .modern-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .modern-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  
  .summary-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .summary-header {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }
  
  .project-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }
  
  .project-list li {
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .project-list li:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .project-name {
    font-weight: 500;
    color: #495057;
  }
  
  .project-amount {
    font-weight: 600;
    color: #dc3545;
  }
  
  /* Botones modernos */
  .btn-modern {
    border-radius: 10px;
    font-weight: 500;
    padding: 0.6rem 1.5rem;
    transition: all 0.2s ease;
    border: none;
  }
  
  .btn-modern:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .btn-primary-modern {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
  }
  
  .btn-secondary-modern {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
  }
  
  /* Input de fecha mejorado */
  .date-input {
    border: 1px solid #ced4da;
    border-radius: 6px;
    padding: 0.375rem 0.5rem;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    width: 100%;
  }
  
  .date-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
  }
  
  /* Anchos de columnas específicos */
  .col-fecha-op { width: 85px; }
  .col-opago { width: 80px; }
  .col-proveedor { width: 150px; }
  .col-detalle { width: 200px; }
  .col-factura { width: 70px; min-width: 40px; max-width: 120px; }
  .col-fac-pago { width: 60px; min-width: 50px; max-width: 80px; }
  /* Estilos para el resizer de columnas */
  .payment-table th { position: relative; }
  .resizer {
    position: absolute;
    right: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: col-resize;
    user-select: none;
    z-index: 10;
    background: transparent;
  }
  .resizer:hover {
    background: #007bff22;
  }

  .col-total-pago { width: 100px; text-align: right; }
  .col-fecha-pago { width: 130px; }
  .col-proyecto { width: 120px; }
  .col-orden-compra { width: 100px; }
  .col-condicion { width: 120px; }
  .col-cuenta { width: 100px; }
  .col-vencimiento { width: 100px; }
  .col-fecha-factura { width: 100px; }
  
  /* Responsive mejoras */
  .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .table-responsive {
    max-height: 70vh;
    overflow-x: auto;
    overflow-y: auto;
  }
  
  /* Stats indicators */
  .stats-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .stats-pending { background-color: #dc3545; }
  .stats-paid { background-color: #28a745; }
  
  /* Estilos para filas de pagos */
  .row-paid {
    background-color: #d4edda !important; /* Verde suave para pagadas */
  }
  
  .row-partial {
    background-color: #fff3cd !important; /* Amarillo suave para abonos parciales */
  }
  
  .row-paid:hover, .row-partial:hover {
    filter: brightness(0.95); /* Efecto hover para filas coloreadas */
  }
  
  /* Mejoras para búsqueda y filtros */
  .search-highlight {
    background-color: #fff3cd !important;
    transition: background-color 0.3s ease;
  }
  
  .filter-badge {
    position: relative;
    overflow: hidden;
  }
  
  .filter-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
  }
  
  .filter-badge:hover::before {
    left: 100%;
  }
  
  /* Animaciones para las tarjetas de estadísticas */
  .card {
    transition: all 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  /* Input de búsqueda mejorado */
  .input-group .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
  }
  
  /* Indicador de cambios no guardados */
  .date-input.changed {
    border-color: #28a745 !important;
    border-width: 2px !important;
    background-color: #f8fff9;
  }
  
  /* Efectos de hover mejorados para la tabla */
  .payment-table tbody tr {
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .payment-table tbody tr:hover {
    background-color: rgba(0,123,255,0.08);
    transform: scale(1.001);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* Spinner de carga para filtros */
  .loading-spinner {
    display: none;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Responsive improvements */
  @media (max-width: 768px) {
    .payment-table {
      font-size: 0.75rem;
    }
    
    .payment-table th,
    .payment-table td {
      padding: 0.3rem;
    }
    
    .summary-card {
      margin-bottom: 1rem;
    }
  }

</style>

<!-- Header con título y controles -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="titulo-modulo titulo-modulo-con-icono mb-0">
    <span class="icono-modulo">💰</span>
    Informe de Pagos Somyl.
  </h1>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
      <i class="bi bi-x-circle me-1"></i>Limpiar
    </button>
  </div>
</div>

<!-- Búsqueda rápida -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="input-group mb-2">
      <span class="input-group-text">
        <i class="bi bi-search"></i>
      </span>
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar por proveedor, detalle, factura o proyecto...">
    </div>
    <div class="input-group">
      <span class="input-group-text">
        <i class="bi bi-hash"></i>
      </span>
      <input type="text" id="ordenPagoInput" class="form-control" placeholder="Buscar por N° Orden de Pago...">
    </div>
  </div>
  <div class="col-md-6">
    <div class="d-flex justify-content-end gap-2">
      <select id="estadoFilter" class="form-select form-select-sm" style="width: auto;">
        <option value="">Todos los estados</option>
        <option value="pendiente">Pendientes</option>
        <option value="pagado">Pagados</option>
        <option value="abono">Abonos Parciales</option>
      </select>
      <select id="proyectoFilter" class="form-select form-select-sm" style="width: auto;">
        <option value="">Todos los proyectos</option>
        {% for proyecto in proyectos_unicos %}
        <option value="{{ proyecto }}">{{ proyecto }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<!-- Card de resumen de proyectos pendientes -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="row">
      <div class="col-md-3">
        <div class="card border-0 bg-light">
          <div class="card-body text-center">
            <h5 class="card-title text-primary">{{ pagos|length }}</h5>
            <p class="card-text text-muted mb-0">Total Órdenes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 bg-success bg-opacity-10">
          <div class="card-body text-center">
            <h5 class="card-title text-success">{{ pagos|selectattr('fecha_pago')|list|length }}</h5>
            <p class="card-text text-muted mb-0">Pagadas</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 bg-danger bg-opacity-10">
          <div class="card-body text-center">
            <h5 class="card-title text-danger">{{ pagos|rejectattr('fecha_pago')|list|length }}</h5>
            <p class="card-text text-muted mb-0">Pendientes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 bg-warning bg-opacity-10">
          <div class="card-body text-center">
            <h5 class="card-title text-warning">${{ "{:,.0f}".format(total_pendiente).replace(',', '.') }}</h5>
            <p class="card-text text-muted mb-0">Monto Pendiente</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="summary-card">
      {% set pending = {} %}
      {% for p in pagos %}
        {% if not p.fecha_pago %}
          {% set _ = pending.update({p.proyecto: (pending.get(p.proyecto, 0) + p.total_pago)}) %}
        {% endif %}
      {% endfor %}
      <div class="summary-header mb-3">
        <span class="stats-indicator stats-pending"></span>
        Proyectos Pendientes de Pago
      </div>
      <ul class="project-list">
        {% for proyecto, monto in pending.items() %}
        <li>
          <span class="project-name">{{ proyecto }}</span>
          <span class="project-amount">${{ '{:,.0f}'.format(monto).replace(',', '.') }}</span>
        </li>
        {% endfor %}
      </ul>
      {% set grand_total = pending.values()|sum %}
      <div class="total-summary mt-4">
        <!-- Cuadro para mostrar la suma filtrada de SALDO PENDIENTE -->
        <!-- Eliminado: <div id="saldo-pendiente-summary" class="total-summary mt-2" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #212529;"> SALDO PENDIENTE: <span id="saldoPendienteTotal">$0</span></div> -->
      </div>
    </div>
  </div>
</div>
<!-- Formulario principal con tabla -->
<div class="modern-card">
  <form method="POST" action="{{ url_for('pagos.update_pagos') }}">
    <!-- Botones de acción -->
    <div class="p-3 border-bottom" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        {% if puede_editar %}
        <button type="submit" class="btn btn-primary-modern btn-modern">
          <i class="bi bi-floppy me-2"></i>Guardar Fechas de Pago
        </button>
        {% endif %}
        <button type="button" class="btn btn-secondary-modern btn-modern" onclick="exportarFiltrados()">
          <i class="bi bi-file-earmark-excel me-2"></i>Exportar a Excel
        </button>
        <div class="ms-auto d-flex align-items-center">
          <span class="badge bg-light text-dark me-2">
            <span class="stats-indicator stats-paid"></span>
            {{ pagos|selectattr('fecha_pago')|list|length }} Pagados
          </span>
          <span class="badge bg-light text-dark">
            <span class="stats-indicator stats-pending"></span>
            {{ pagos|rejectattr('fecha_pago')|list|length }} Pendientes
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla responsiva -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="payment-table">
          <thead>
            <tr>
              <th class="col-fecha-op">FECHA<br>OP</th>
              <th class="col-opago">O.PAGO</th>
              <th class="col-proveedor">PROVEEDOR</th>
              <th class="col-rut">RUT</th>
              <th class="col-detalle">DETALLE O.PAGO</th>
              <th class="col-factura">FACTURA<br>ASOCIADA</th>
              <th class="col-fac-pago">FAC.<br>PAGO</th>
              <th class="col-total-pago">TOTAL<br>PAGO</th>
              <th>ABONADO</th>
              <th>SALDO<br>PENDIENTE</th>
              <th>HISTORIAL<br>ABONOS</th>
              <th class="col-fecha-pago">FECHA DE<br>PAGO</th>
              <th class="col-proyecto">PROYECTO</th>
              <th class="col-orden-compra">O.COMPRA</th>
              <th class="col-item">ITEM(S)</th>
              <th class="col-condicion">CONDICIÓN<br>PAGO</th>
              <th class="col-vencimiento">VENCIMIENTO<br>FAC.</th>
              <th class="col-fecha-factura">FECHA<br>FAC.</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pagos %}
            {% set estado_pago = "pendiente" %}
            {% if p.fecha_pago %}
                {% set estado_pago = "pagado" %}
            {% elif p.total_abonado > 0 and p.saldo_pendiente > 0 %}
                {% set estado_pago = "abono" %}
            {% endif %}
            <tr class="{% if estado_pago == 'pagado' %}row-paid{% elif estado_pago == 'abono' %}row-partial{% endif %}" data-orden="{{ p.orden_numero }}" data-estado="{{ estado_pago }}">
              <td class="col-fecha-op">
                <small class="text-muted">{{ p.fecha }}</small>
              </td>
              <td class="col-opago">
                <strong>{{ p.orden_numero }}</strong>
                <input type="hidden" name="orden_numero[]" value="{{ p.orden_numero }}">
              </td>
              <td class="col-proveedor">
                <div class="text-truncate" style="max-width: 140px;" title="{{ p.proveedor_nombre }}">
                  {{ p.proveedor_nombre }}
                </div>
              </td>
              <td class="col-rut">
                <div class="text-truncate" style="max-width: 110px;" title="{{ p.rut_proveedor }}">
                  {{ p.rut_proveedor if p.rut_proveedor else '-' }}
                </div>
              </td>
              <td class="col-detalle">
                <div class="text-truncate" style="max-width: 180px;" title="{{ p.detalle_compra }}">
                  {{ p.detalle_compra }}
                </div>
              </td>
              <td class="col-factura">
                {% if p.factura %}
                  <span class="badge bg-primary">{{ p.factura }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-fac-pago">
                {% if p.fac_pago == "SI" %}
                  <span class="badge bg-success">SI</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            <td class="col-total-pago">
              <strong class="text-{% if p.fecha_pago %}success{% else %}danger{% endif %}">
                ${{ "{:,.0f}".format(p.total_pago).replace(',', '.') }}
              </strong>
            </td>
            <td>
              <span class="text-primary">${{ "{:,.0f}".format(p.total_abonado).replace(',', '.') }}</span>
            </td>
            <td class="col-saldo-pendiente">
              <span class="text-danger">${{ "{:,.0f}".format(p.saldo_pendiente).replace(',', '.') }}</span>
            </td>
            <td>
              <button type="button" class="btn btn-outline-info btn-sm" onclick="showAbonos({{ p.orden_numero }})">Ver</button>
            </td>
              <td class="col-fecha-pago">
                <input type="date"
                       name="fecha_pago[]"
                       class="date-input"
                       value="{{ p.fecha_pago or '' }}"
                       min="1900-01-01"
                       max="{{ fecha_maxima }}"
                       title="Fecha de pago para orden {{ p.orden_numero }}"
                       {% if not puede_editar %}disabled{% endif %}>
              </td>
              <td class="col-proyecto">
                <span class="badge bg-secondary">{{ p.proyecto }}</span>
              </td>
              <td class="col-orden-compra">
                {% if p.orden_compra %}
                  {{ p.orden_compra }}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-item">
                {% if p.item %}
                  <span title="{{ p.item }}">{{ p.item }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-condicion">
                <small>{{ p.condicion_pago or '-' }}</small>
              </td>
              <!-- <td class="col-cuenta">
                <small>{{ p.cuenta or '-' }}</small>
              </td> -->
              <td class="col-vencimiento">
                {% if p.vencimiento %}
                  <small class="text-muted">{{ p.vencimiento }}</small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="col-fecha-factura">
                {% if p.fecha_factura %}
                  <small class="text-muted">{{ p.fecha_factura }}</small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Footer con información adicional -->
    <div class="p-3 border-top" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div class="row">
        <div class="col-md-6">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Total de órdenes: {{ pagos|length }}
          </small>
        </div>
        <div class="col-md-6 text-end">
          <small class="text-muted">
            {% set monto_pagado = pagos|selectattr('fecha_pago')|sum(attribute='total_pago') %}
            Pagado: ${{ "{:,.0f}".format(monto_pagado).replace(',', '.') }} | 
            Pendiente: ${{ "{:,.0f}".format(total_pendiente).replace(',', '.') }}
          </small>
        </div>
      </div>
    </div>
  </form>
</div>


<!-- Scripts adicionales para mejorar la experiencia -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Referencias a elementos
  const searchInput = document.getElementById('searchInput');
  const estadoFilter = document.getElementById('estadoFilter');
  const proyectoFilter = document.getElementById('proyectoFilter');
  const tableRows = document.querySelectorAll('tbody tr');
  const dateInputs = document.querySelectorAll('.date-input');
  const ordenPagoInput = document.getElementById('ordenPagoInput');

  // Función de búsqueda y filtrado en tiempo real
  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const estadoValue = estadoFilter.value;
    const proyectoValue = proyectoFilter.value;
    const ordenPagoValue = ordenPagoInput.value.toLowerCase();

    let visibleRows = 0;

    tableRows.forEach(row => {
      const proveedor = row.querySelector('.col-proveedor').textContent.toLowerCase();
      const detalle = row.querySelector('.col-detalle').textContent.toLowerCase();
      const factura = row.querySelector('.col-factura').textContent.toLowerCase();
      const proyecto = row.querySelector('.col-proyecto').textContent.toLowerCase();
      const ordenPago = row.querySelector('.col-opago').textContent.toLowerCase();
      const esPagado = row.classList.contains('row-paid');
      const esAbono = row.classList.contains('row-partial');

      // Verificar filtros
      let mostrarFila = true;

      // Filtro de búsqueda
      if (searchTerm && !proveedor.includes(searchTerm) && 
          !detalle.includes(searchTerm) && !factura.includes(searchTerm) && 
          !proyecto.includes(searchTerm)) {
        mostrarFila = false;
      }

      // Filtro de estado
      if (estadoValue === 'pendiente' && (esPagado || esAbono)) {
        mostrarFila = false;
      } else if (estadoValue === 'pagado' && !esPagado) {
        mostrarFila = false;
      } else if (estadoValue === 'abono' && !esAbono) {
        mostrarFila = false;
      }

      // Filtro de proyecto
      if (proyectoValue && !proyecto.includes(proyectoValue.toLowerCase())) {
        mostrarFila = false;
      }

      // Filtro por N° Orden de Pago (coincidencia parcial)
      if (ordenPagoValue && !ordenPago.includes(ordenPagoValue)) {
        mostrarFila = false;
      }

      // Mostrar/ocultar fila
      if (mostrarFila) {
        row.style.display = '';
        visibleRows++;
      } else {
        row.style.display = 'none';
      }
    });

    // Actualizar contador de resultados
    updateResultsCounter(visibleRows);
  }

  // Función para actualizar contador de resultados
  function updateResultsCounter(count) {
    let counter = document.getElementById('resultsCounter');
    if (!counter) {
      counter = document.createElement('div');
      counter.id = 'resultsCounter';
      counter.className = 'alert alert-info py-2 px-3 mt-2 mb-0';
      const tableContainer = document.querySelector('.table-container');
      tableContainer.appendChild(counter);
    }

    if (count === tableRows.length) {
      counter.style.display = 'none';
    } else {
      counter.style.display = 'block';
      counter.innerHTML = `<i class="bi bi-info-circle me-2"></i>Mostrando ${count} de ${tableRows.length} órdenes de pago`;
    }
  }

  // Event listeners para filtros en tiempo real
  searchInput.addEventListener('input', filterTable);
  estadoFilter.addEventListener('change', filterTable);
  proyectoFilter.addEventListener('change', filterTable);
  ordenPagoInput.addEventListener('input', filterTable);

  // Destacar filas al cambiar fecha de pago
  dateInputs.forEach(input => {
    input.addEventListener('change', function() {
      const row = this.closest('tr');
      if (this.value) {
        row.classList.add('row-paid');
        this.style.backgroundColor = '#d4edda';
      } else {
        row.classList.remove('row-paid');
        this.style.backgroundColor = '';
      }
      // Actualizar filtros después del cambio
      setTimeout(filterTable, 100);
    });
  });

  // Tooltip para celdas truncadas
  const truncatedCells = document.querySelectorAll('.text-truncate');
  truncatedCells.forEach(cell => {
    cell.addEventListener('mouseenter', function() {
      if (this.scrollWidth > this.clientWidth) {
        this.setAttribute('title', this.textContent);
      }
    });
  });

  // Confirmación antes de enviar formulario
  const form = document.querySelector('form');
  let isSubmitting = false; // Protección contra envío duplicado
  
  form.addEventListener('submit', function(e) {
    // Prevenir envío duplicado
    if (isSubmitting) {
      e.preventDefault();
      return false;
    }
    
    const changedDates = Array.from(dateInputs).filter(input => input.value && input.style.backgroundColor).length;
    if (changedDates > 0) {
      if (!confirm(`¿Confirma guardar ${changedDates} fecha(s) de pago?`)) {
        e.preventDefault();
        return false;
      }
    }
    
    // Marcar como enviando para prevenir duplicados
    isSubmitting = true;
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    }
  });

  // Resaltar cambios no guardados
  dateInputs.forEach(input => {
    const originalValue = input.value;
    input.addEventListener('change', function() {
      if (this.value !== originalValue) {
        this.style.borderColor = '#28a745';
        this.style.borderWidth = '2px';
      } else {
        this.style.borderColor = '';
        this.style.borderWidth = '';
      }
    });
  });

  window.limpiarFiltros = function() {
    // Limpiar filtros de la página actual
    document.getElementById('searchInput').value = '';
    document.getElementById('estadoFilter').value = '';
    document.getElementById('proyectoFilter').value = '';
    ordenPagoInput.value = '';
    filterTable();
    // Recargar página sin filtros
    window.location.href = window.location.pathname;
  };

  // Función para procesar montos con formato chileno
  function procesarMonto(texto) {
    if (!texto || texto === '-' || texto === '0' || texto === '$0') {
      return '0';
    }
    
    // Remover el símbolo de peso y espacios
    let monto = texto.replace(/\$/, '').trim();
    
    // Si contiene puntos y comas, es formato chileno (ej: 3.919.860)
    if (monto.includes('.') && !monto.includes(',')) {
      // En formato chileno, los puntos son separadores de miles
      // Convertir a formato numérico estándar
      const partes = monto.split('.');
      if (partes.length > 1) {
        // Si hay múltiples puntos, todos son separadores de miles excepto el último que podría ser decimal
        // Pero en formato chileno típico, no hay decimales con punto
        monto = partes.join('');
      }
    }
    
    // Limpiar cualquier carácter no numérico excepto comas para decimales
    monto = monto.replace(/[^\d,]/g, '');
    
    // Si hay coma, es separador decimal
    if (monto.includes(',')) {
      monto = monto.replace(',', '.');
    }
    
    return monto || '0';
  }

  // Exportar datos filtrados desde la tabla visible
window.exportarFiltrados = function() {
  if (typeof XLSX === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    script.onload = function() {
      exportarFiltrados();
    };
    document.body.appendChild(script);
    return;
  }
  
  const table = document.querySelector('.payment-table');
  if (!table) {
    return;
  }
  
  // Crear una tabla temporal solo con los datos visibles
  const tempTable = document.createElement('table');
  tempTable.className = table.className;
  // Copiar el thead
  tempTable.appendChild(table.tHead.cloneNode(true));
  
  // Copiar solo las filas visibles del tbody
  const tempTbody = document.createElement('tbody');
  let rowCount = 0;
  
  table.querySelectorAll('tbody tr').forEach((row, rowIndex) => {
    if (row.style.display === 'none') return;
    
    rowCount++;
    const newRow = document.createElement('tr');
    
    row.querySelectorAll('td').forEach((td, colIndex) => {
      const newTd = document.createElement('td');
      let value = '';
      
      // Estrategia específica por tipo de columna según el índice
      const input = td.querySelector('input:not([type="hidden"])');
      const button = td.querySelector('button');
      const span = td.querySelector('span');
      const strong = td.querySelector('strong');
      const small = td.querySelector('small');
      const div = td.querySelector('div');
      
      if (button && !input) {
        // Para columnas con botones (como "Ver" en historial), no exportar nada
        value = '';
      } else if (input) {
        // Para inputs (principalmente fecha de pago)
        value = input.value || '';
        if (input.type === 'date' && value) {
          // Formatear fecha para mejor legibilidad
          const date = new Date(value);
          value = date.toLocaleDateString('es-CL');
        }
      } else if (span && span.classList.contains('badge')) {
        // Para badges (proyecto, factura) - prioridad alta
        value = span.textContent.trim();
      } else if (span && (span.classList.contains('text-primary') || span.classList.contains('text-danger') || span.classList.contains('text-success'))) {
        // Para spans con clases de colores (montos abonados, saldos pendientes)
        value = span.textContent.trim();
        // Procesar montos con formato chileno
        value = procesarMonto(value);
      } else if (strong) {
        // Para elementos strong (principalmente montos)
        value = strong.textContent.trim();
        // Procesar montos con formato chileno
        value = procesarMonto(value);
      } else if (small) {
        // Para elementos small (fechas, condiciones)
        value = small.textContent.trim();
      } else if (div && div.classList.contains('text-truncate')) {
        // Para divs truncados (proveedor, detalle, rut)
        value = div.textContent.trim();
      } else if (span) {
        // Para cualquier otro span
        value = span.textContent.trim();
      } else {
        // Para el resto, extraer todo el texto visible
        value = td.textContent.trim();
        
        // Limpiar caracteres especiales y espacios extra
        value = value.replace(/\s+/g, ' ').trim();
      }
      
      // Limpiar valores específicos que no queremos
      if (value === '-' || value === 'Ver' || value === 'Registrar abono') {
        value = '';
      }
      
      newTd.textContent = value;
      newRow.appendChild(newTd);
    });
    tempTbody.appendChild(newRow);
  });
  
  tempTable.appendChild(tempTbody);
  
  const wb = XLSX.utils.table_to_book(tempTable, {sheet: 'Pagos'});
  
  // Generar nombre de archivo con fecha y hora
  const now = new Date();
  const timestamp = now.toISOString().slice(0,16).replace('T', '_').replace(/:/g, '-');
  const filename = `informe_pagos_${timestamp}.xlsx`;
  
  XLSX.writeFile(wb, filename);
  
  // Mostrar mensaje de éxito
  alert('Excel emitido correctamente');
};
});
</script>


{% endblock %}