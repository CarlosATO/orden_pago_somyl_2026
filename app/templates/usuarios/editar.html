{% extends "base.html" %}
{% block title %}Editar Usuario - SOMYL{% endblock %}

{% block content %}
<style>
  .card {
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
  }
  
  .user-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 28px;
    margin: 0 auto 20px;
  }
  
  .module-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
  }
  
  .module-card:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
  }
  
  .module-card.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
  }
  
  .btn {
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    transform: translateY(-1px);
  }
  
  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }
</style>

<!-- Mostrar mensajes flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
        <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row">
  <div class="col-md-4">
    <!-- Información del usuario -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-light border-0 py-3">
        <h5 class="mb-0 fw-bold text-center">
          <i class="bi bi-person-circle me-2"></i>Información del Usuario
        </h5>
      </div>
      <div class="card-body text-center">
        <div class="user-avatar bg-primary">
          {{ usuario.nombre[0].upper() }}
        </div>
        <h4 class="fw-bold mb-1">{{ usuario.nombre }}</h4>
        <p class="text-muted mb-3">{{ usuario.email }}</p>
        
        <div class="row text-center mb-3">
          <div class="col-4">
            <div class="border-end">
              <h6 class="mb-0 fw-bold">{{ modulos_usuario | length }}</h6>
              <small class="text-muted">Módulos</small>
            </div>
          </div>
          <div class="col-4">
            <div class="border-end">
              <h6 class="mb-0 fw-bold">
                {% if usuario.get('activo', True) %}
                  <span class="text-success">Activo</span>
                {% else %}
                  <span class="text-secondary">Inactivo</span>
                {% endif %}
              </h6>
              <small class="text-muted">Estado</small>
            </div>
          </div>
          <div class="col-4">
            <h6 class="mb-0 fw-bold">
              {% if usuario.get('bloqueado', False) %}
                <span class="text-danger">Bloqueado</span>
              {% else %}
                <span class="text-success">Libre</span>
              {% endif %}
            </h6>
            <small class="text-muted">Acceso</small>
          </div>
        </div>
        
        <div class="d-grid gap-2">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-{{ 'secondary' if usuario.get('activo', True) else 'success' }} btn-sm toggle-estado-btn"
                    data-id="{{ usuario.id }}"
                    data-estado="{{ usuario.get('activo', True) | lower }}">
              <i class="bi bi-{{ 'pause' if usuario.get('activo', True) else 'play' }} me-1"></i>
              {{ 'Desactivar' if usuario.get('activo', True) else 'Activar' }}
            </button>
            <button type="button" class="btn btn-outline-{{ 'warning' if usuario.get('bloqueado', False) else 'danger' }} btn-sm toggle-bloqueo-btn"
                    data-id="{{ usuario.id }}"
                    data-bloqueado="{{ usuario.get('bloqueado', False) | lower }}">
              <i class="bi bi-{{ 'unlock' if usuario.get('bloqueado', False) else 'lock' }} me-1"></i>
              {{ 'Desbloquear' if usuario.get('bloqueado', False) else 'Bloquear' }}
            </button>
          </div>
          <button type="button" class="btn btn-info btn-sm reset-password-btn" data-id="{{ usuario.id }}">
            <i class="bi bi-key me-1"></i>Restablecer Contraseña
          </button>
        </div>
      </div>
    </div>
    
    <!-- Información adicional -->
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0 fw-bold">
          <i class="bi bi-info-circle me-2"></i>Información Adicional
        </h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label small fw-medium text-muted">FECHA DE CREACIÓN</label>
          <p class="mb-0">
            {% if usuario.get('fecha_creacion') %}
              {{ usuario.fecha_creacion[:10] }}
            {% else %}
              <span class="text-muted">No disponible</span>
            {% endif %}
          </p>
        </div>
        
        <div class="mb-3">
          <label class="form-label small fw-medium text-muted">ÚLTIMO ACCESO</label>
          <p class="mb-0">
            {% if usuario.get('fecha_ultimo_acceso') %}
              {{ usuario.fecha_ultimo_acceso[:10] }}
            {% else %}
              <span class="text-warning">Sin acceso registrado</span>
            {% endif %}
          </p>
        </div>
        
        <div class="mb-0">
          <label class="form-label small fw-medium text-muted">INTENTOS FALLIDOS</label>
          <p class="mb-0">
            {% if usuario.get('intentos_fallidos', 0) > 0 %}
              <span class="text-danger fw-bold">{{ usuario.intentos_fallidos }}</span>
            {% else %}
              <span class="text-success">0</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-8">
    <!-- Editar información básica -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-light border-0 py-3">
        <h5 class="mb-0 fw-bold">
          <i class="bi bi-pencil me-2"></i>Editar Información Básica
        </h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('usuarios.editar_usuario', id=usuario.id) }}">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="nombre" class="form-label fw-medium">
                  <i class="bi bi-person me-1"></i>Nombre Completo
                </label>
                <input type="text" class="form-control" id="nombre" name="nombre" 
                       value="{{ usuario.nombre }}" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="email" class="form-label fw-medium">
                  <i class="bi bi-envelope me-1"></i>Correo Electrónico
                </label>
                <input type="email" class="form-control" id="email" name="email" 
                       value="{{ usuario.email }}" required>
              </div>
            </div>
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check me-1"></i>Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Gestión de permisos -->
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-header bg-light border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-grid me-2"></i>Permisos de Módulos
          </h5>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllModules()">
              <i class="bi bi-check-all me-1"></i>Todos
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllModules()">
              <i class="bi bi-x-circle me-1"></i>Ninguno
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <form id="modulos-form">
          <div class="row">
            {% for modulo in modulos %}
            <div class="col-md-4 mb-3">
              <div class="module-card {% if modulo.id in modulos_usuario %}selected{% endif %}">
                <div class="form-check">
                  <input class="form-check-input modulo-checkbox"
                         type="checkbox"
                         value="{{ modulo.id }}"
                         id="modulo{{ modulo.id }}"
                         {% if modulo.id in modulos_usuario %}checked{% endif %}
                         data-usuario="{{ usuario.id }}">
                  <label class="form-check-label fw-medium" for="modulo{{ modulo.id }}">
                    <i class="bi bi-app me-1"></i>{{ modulo.nombre_modulo }}
                  </label>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </form>
        
        <div id="permiso-msg" style="display:none;" class="alert mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Botón volver -->
<div class="row mt-4">
  <div class="col-md-12">
    <a href="{{ url_for('usuarios.list_usuarios') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>Volver a la Lista
    </a>
  </div>
</div>

<!-- Eliminamos el modal problemático y usamos método directo -->

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Gestión de permisos de módulos
  document.querySelectorAll('.modulo-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const usuarioId = this.getAttribute('data-usuario');
      const moduloId = this.value;
      const checked = this.checked;
      const card = this.closest('.module-card');
      
      // Visual feedback
      if (checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
      
      fetch('{{ url_for("usuarios.toggle_modulo_permiso") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          usuario_id: usuarioId,
          modulo_id: moduloId,
          permitir: checked
        })
      })
      .then(response => response.json())
      .then(data => {
        const msgDiv = document.getElementById('permiso-msg');
        msgDiv.style.display = 'block';
        msgDiv.className = 'alert mt-3 ' + (data.success ? 'alert-success' : 'alert-danger');
        msgDiv.innerHTML = '<i class="bi bi-' + (data.success ? 'check-circle' : 'exclamation-triangle') + ' me-1"></i>' + data.message;
        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
      })
      .catch(() => {
        const msgDiv = document.getElementById('permiso-msg');
        msgDiv.style.display = 'block';
        msgDiv.className = 'alert mt-3 alert-danger';
        msgDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error al actualizar permisos.';
        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
      });
    });
  });

  // Toggle estado
  document.querySelectorAll('.toggle-estado-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const estadoActual = this.dataset.estado === 'true';
      const nuevoEstado = !estadoActual;
      
      fetch(`/usuarios/toggle_estado/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ activo: nuevoEstado })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message);
        }
      });
    });
  });

  // Toggle bloqueo
  document.querySelectorAll('.toggle-bloqueo-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const bloqueadoActual = this.dataset.bloqueado === 'true';
      const nuevoBloqueado = !bloqueadoActual;
      
      fetch(`/usuarios/toggle_bloqueo/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bloqueado: nuevoBloqueado })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message);
        }
      });
    });
  });

  // Reset password
  document.querySelectorAll('.reset-password-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      
      if (confirm('¿Estás seguro de que quieres restablecer la contraseña de este usuario?')) {
        // Mostrar feedback visual
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        this.disabled = true;
        
        fetch(`/usuarios/reset_password/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Mostrar la contraseña directamente con prompt y opción de copiar
            const password = data.password_temp;
            const message = `Contraseña temporal generada:\n\n${password}\n\nEsta contraseña es temporal. El usuario debería cambiarla en su próximo inicio de sesión.\n\n¿Deseas copiar la contraseña al portapapeles?`;
            
            if (confirm(message)) {
              // Copiar al portapapeles
              navigator.clipboard.writeText(password).then(() => {
                alert('Contraseña copiada al portapapeles');
              }).catch(() => {
                // Fallback si no se puede copiar automáticamente
                prompt('Contraseña generada (selecciona y copia):', password);
              });
            }
            
            // Actualizar la página para reflejar cambios
            location.reload();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al restablecer contraseña');
        })
        .finally(() => {
          // Restaurar botón
          this.innerHTML = originalText;
          this.disabled = false;
        });
      }
    });
  });
});

function selectAllModules() {
  document.querySelectorAll('.modulo-checkbox').forEach(checkbox => {
    if (!checkbox.checked) {
      checkbox.click();
    }
  });
}

function deselectAllModules() {
  document.querySelectorAll('.modulo-checkbox').forEach(checkbox => {
    if (checkbox.checked) {
      checkbox.click();
    }
  });
}
</script>
{% endblock %}