<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOMYL - Sistema de Compras Moderno</title>
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #4f46e5;
        --primary-dark: #3730a3;
        --secondary-color: #7c3aed;
        --accent-color: #f59e0b;
        --success-color: #059669;
        --danger-color: #dc2626;
        --warning-color: #d97706;
        --info-color: #0891b2;
        --dark-color: #1f2937;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --sidebar-width: 280px;
        --sidebar-collapsed: 70px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: var(--text-primary);
        margin: 0;
        overflow-x: hidden;
      }

      /* Sidebar Principal */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(180deg, #ffffff 0%, #fafbff 100%);
        border-right: 1px solid var(--border-color);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        transition: width var(--transition);
        overflow: hidden;
      }

      .sidebar.collapsed {
        width: var(--sidebar-collapsed);
      }

      /* Header del Sidebar */
      .sidebar-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .sidebar-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(180deg); }
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        position: relative;
        z-index: 1;
      }

      .logo-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 700;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .logo-text {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: -0.5px;
        transition: opacity var(--transition);
      }

      .sidebar.collapsed .logo-text {
        opacity: 0;
        width: 0;
      }

      .toggle-btn {
        position: fixed;
        top: 32px;
        left: calc(var(--sidebar-width) - 12px);
        z-index: 1100;
        width: 28px;
        height: 28px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow-md);
        transition: all var(--transition);
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .sidebar.collapsed ~ .toggle-btn {
        left: calc(var(--sidebar-collapsed) - 12px);
      }

      .toggle-btn:hover {
        background: var(--bg-secondary);
        transform: translateY(-50%) scale(1.1);
      }

      /* Navegación Principal */
      .sidebar-nav {
        flex: 1;
        padding: var(--spacing-lg) 0;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(79, 70, 229, 0.2) transparent;
      }

      .sidebar-nav::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar-nav::-webkit-scrollbar-thumb {
        background: rgba(79, 70, 229, 0.2);
        border-radius: 2px;
      }

      .nav-section {
        margin-bottom: var(--spacing-lg);
      }

      .nav-section-title {
        padding: 0 var(--spacing-lg);
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: var(--spacing-sm);
        transition: opacity var(--transition);
      }

      .sidebar.collapsed .nav-section-title {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
      }

      .nav-item {
        margin: 0 var(--spacing-sm);
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: var(--radius-md);
        transition: all var(--transition);
        font-weight: 500;
        font-size: 0.875rem;
        position: relative;
        overflow: hidden;
        margin-bottom: var(--spacing-xs);
      }

      .nav-link::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--primary-color);
        transform: scaleY(0);
        transition: transform var(--transition);
      }

      .nav-link:hover {
        background: rgba(79, 70, 229, 0.05);
        color: var(--primary-color);
        transform: translateX(4px);
      }

      .nav-link.active {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .nav-link.active::before {
        transform: scaleY(1);
        background: rgba(255, 255, 255, 0.3);
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
      }

      .nav-text {
        flex: 1;
        white-space: nowrap;
        transition: opacity var(--transition);
      }

      .sidebar.collapsed .nav-text {
        opacity: 0;
        width: 0;
      }

      .nav-arrow {
        font-size: 0.7rem;
        transition: transform var(--transition);
      }

      .nav-link[aria-expanded="true"] .nav-arrow {
        transform: rotate(180deg);
      }

      /* Submenús */
      .submenu {
        margin-left: var(--spacing-lg);
        margin-top: var(--spacing-xs);
        border-left: 2px solid rgba(79, 70, 229, 0.1);
        padding-left: var(--spacing-sm);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .submenu.show {
        max-height: 500px;
      }

      .sidebar.collapsed .submenu {
        display: none;
      }

      .submenu .nav-link {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.8rem;
        margin-left: 0;
      }

      .submenu .nav-link.active {
        background: var(--success-color);
        box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
      }

      /* Footer del Sidebar */
      .sidebar-footer {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        background: rgba(248, 250, 252, 0.8);
        backdrop-filter: blur(10px);
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition);
      }

      .user-profile:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
      }

      .user-info {
        flex: 1;
        min-width: 0;
        transition: opacity var(--transition);
      }

      .sidebar.collapsed .user-info {
        opacity: 0;
        width: 0;
      }

      .user-name {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-primary);
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .user-role {
        font-size: 0.7rem;
        color: var(--text-muted);
        font-family: 'Monaco', monospace;
      }

      .payment-status {
        background: white;
        border-radius: var(--radius-md);
        padding: var(--spacing-sm);
        text-align: center;
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-sm);
        transition: opacity var(--transition);
      }

      .sidebar.collapsed .payment-status {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
      }

      .payment-label {
        font-size: 0.65rem;
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: var(--spacing-xs);
      }

      .payment-amount {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--danger-color);
      }

      .logout-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        background: linear-gradient(135deg, var(--danger-color) 0%, #b91c1c 100%);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all var(--transition);
        text-decoration: none;
      }

      .logout-btn:hover {
        background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        color: white;
      }

      .logout-text {
        transition: opacity var(--transition);
      }

      .sidebar.collapsed .logout-text {
        opacity: 0;
        width: 0;
      }

      /* Contenido Principal */
      .content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        padding: var(--spacing-xl);
        transition: margin-left var(--transition);
      }

      .sidebar.collapsed + .content {
        margin-left: var(--sidebar-collapsed);
      }

      .container-glass {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        padding: var(--spacing-xl);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .page-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: var(--spacing-xl);
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: var(--spacing-lg);
        border-radius: var(--radius-lg);
        text-align: center;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
      }

      .page-title::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      }

      /* Tooltip para modo colapsado */
      .nav-tooltip {
        position: absolute;
        left: calc(100% + 10px);
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        z-index: 1001;
      }

      .sidebar.collapsed .nav-link:hover .nav-tooltip {
        opacity: 1;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          width: var(--sidebar-width);
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .content {
          margin-left: 0;
        }

        .mobile-toggle {
          position: fixed;
          top: 20px;
          left: 20px;
          z-index: 1001;
          background: var(--primary-color);
          color: white;
          border: none;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: var(--shadow-lg);
          cursor: pointer;
        }

        .sidebar-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          opacity: 0;
          pointer-events: none;
          transition: opacity var(--transition);
        }

        .sidebar-overlay.show {
          opacity: 1;
          pointer-events: all;
        }
      }

      @media (min-width: 769px) {
        .mobile-toggle {
          display: none;
        }
      }

      /* Animaciones de entrada */
      @keyframes slideInFromLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      @keyframes slideInFromRight {
        from { transform: translateX(20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .sidebar {
        animation: slideInFromLeft 0.6s ease-out;
      }

      .content {
        animation: slideInFromRight 0.6s ease-out 0.2s both;
      }

      /* Badge para notificaciones */
      .nav-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <!-- Mobile Toggle -->
    <button class="mobile-toggle d-md-none" onclick="toggleMobileSidebar()">
      <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar Overlay (móvil) -->
    <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <!-- Header -->
      <div class="sidebar-header">
        <div class="logo-container">
          <div class="logo-icon">S</div>
          <div class="logo-text">SOMYL</div>
        </div>
      </div>
      <button class="toggle-btn d-none d-md-flex" onclick="toggleSidebar()" id="sidebarToggleBtn">
        <i class="bi bi-chevron-left"></i>
      </button>

      <!-- Navegación -->
      <nav class="sidebar-nav">
        <!-- Sección: Gestión -->
        <div class="nav-section">
          <div class="nav-section-title">Gestión</div>
          <div class="nav-item">
            <a href="{{ url_for('usuarios.list_usuarios') }}" class="nav-link{% if request.path.startswith('/usuarios') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-person-plus"></i></div>
              <span class="nav-text">Usuarios</span>
              <span class="nav-tooltip">Usuarios</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="{{ url_for('ordenes.new_orden') }}" class="nav-link{% if request.path == url_for('ordenes.new_orden') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-cart-plus"></i></div>
              <span class="nav-text">Orden de Compra</span>
              <span class="nav-tooltip">Orden de Compra</span>
            </a>
          </div>
          {% if 'ingresos' in modulos_usuario %}
          <div class="nav-item">
            <a href="{{ url_for('ingresos.list_ingresos') }}" class="nav-link{% if request.path == url_for('ingresos.list_ingresos') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-arrow-down-circle"></i></div>
              <span class="nav-text">Ingresos</span>
              <span class="nav-tooltip">Ingresos</span>
            </a>
          </div>
          {% endif %}
        </div>

        <!-- Sección: Pagos -->
        <div class="nav-section">
          <div class="nav-section-title">Pagos y Registros</div>
          
          <div class="nav-item">
            {% set pagos_active = request.path == url_for('ordenes_pago.list_ordenes_pago')
              or request.path == url_for('ordenes_pago_pendientes.list_pendientes')
              or request.path == url_for('pagos.list_pagos') %}
            <a href="#pagosSubmenu" class="nav-link{% if pagos_active %} active{% endif %}" data-bs-toggle="collapse" data-bs-target="#pagosSubmenu" aria-expanded="{{ 'true' if pagos_active else 'false' }}">
              <div class="nav-icon"><i class="bi bi-cash-stack"></i></div>
              <span class="nav-text">Pagos</span>
              <i class="bi bi-chevron-down nav-arrow"></i>
              <span class="nav-tooltip">Pagos y registros</span>
            </a>
          </div>
          <div class="submenu{% if pagos_active %} show{% endif %}" id="pagosSubmenu">
            <a href="{{ url_for('ordenes_pago.list_ordenes_pago') }}" class="nav-link{% if request.path == url_for('ordenes_pago.list_ordenes_pago') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-file-earmark-text"></i></div>
              <span class="nav-text">Orden de Pago</span>
            </a>
            <a href="{{ url_for('ordenes_pago_pendientes.list_pendientes') }}" class="nav-link{% if request.path == url_for('ordenes_pago_pendientes.list_pendientes') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-exclamation-circle"></i></div>
              <span class="nav-text">Sin Factura</span>
              {% if total_pendientes_sin_factura and total_pendientes_sin_factura > 0 %}
                <span class="nav-badge" style="position:absolute; right:18px; top:50%; transform:translateY(-50%); font-size:1.15rem; min-width:34px; height:34px; line-height:34px; background:#dc2626; color:#fff; text-align:center; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(220,38,38,0.18); font-weight:700; border-radius:50%; border:3px solid #fff; transition:all 0.2s; z-index:2; letter-spacing:-1px;">{{ total_pendientes_sin_factura }}</span>
              {% endif %}
            </a>
            <a href="{{ url_for('pagos.list_pagos') }}" class="nav-link{% if request.path == url_for('pagos.list_pagos') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-graph-up"></i></div>
              <span class="nav-text">Informe de Pagos</span>
            </a>
          </div>
        </div>

        <!-- Sección: Configuración -->
        <div class="nav-section">
          <div class="nav-section-title">Configuración</div>
          
          <div class="nav-item">
            {% set parametros_active = request.path == url_for('proveedores.list_proveedores')
              or request.path == url_for('materiales.list_materiales')
              or request.path == url_for('items.list_items')
              or request.path == url_for('trabajadores.list_trabajadores')
              or request.path == url_for('proyectos.list_proyectos') %}
            <a href="#parametrosSubmenu" class="nav-link{% if parametros_active %} active{% endif %}" data-bs-toggle="collapse" data-bs-target="#parametrosSubmenu" aria-expanded="{{ 'true' if parametros_active else 'false' }}">
              <div class="nav-icon"><i class="bi bi-gear"></i></div>
              <span class="nav-text">Parámetros</span>
              <i class="bi bi-chevron-down nav-arrow"></i>
              <span class="nav-tooltip">Parámetros</span>
            </a>
          </div>
          <div class="submenu{% if parametros_active %} show{% endif %}" id="parametrosSubmenu">
            <a href="{{ url_for('proveedores.list_proveedores') }}" class="nav-link{% if request.path == url_for('proveedores.list_proveedores') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-building"></i></div>
              <span class="nav-text">Proveedores</span>
            </a>
            <a href="{{ url_for('materiales.list_materiales') }}" class="nav-link{% if request.path == url_for('materiales.list_materiales') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-box"></i></div>
              <span class="nav-text">Materiales</span>
            </a>
            <a href="{{ url_for('items.list_items') }}" class="nav-link{% if request.path == url_for('items.list_items') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-list-ul"></i></div>
              <span class="nav-text">Ítems</span>
            </a>
            <a href="{{ url_for('trabajadores.list_trabajadores') }}" class="nav-link{% if request.path == url_for('trabajadores.list_trabajadores') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-people"></i></div>
              <span class="nav-text">Trabajadores</span>
            </a>
            <a href="{{ url_for('proyectos.list_proyectos') }}" class="nav-link{% if request.path == url_for('proyectos.list_proyectos') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-diagram-3"></i></div>
              <span class="nav-text">Proyectos</span>
            </a>
          </div>
        </div>

        <!-- Sección: Presupuesto -->
        <div class="nav-section">
          <div class="nav-section-title">Presupuesto</div>
          <div class="nav-item">
            {% set presupuesto_active = request.path == url_for('presupuestos.form_presupuesto')
              or request.path == url_for('gastos_directos.form_gastos_directos')
              or request.path == url_for('estado_presupuesto.show_estado') %}
            <a href="#presupuestoSubmenu" class="nav-link{% if presupuesto_active %} active{% endif %}" data-bs-toggle="collapse" data-bs-target="#presupuestoSubmenu" aria-expanded="{{ 'true' if presupuesto_active else 'false' }}">
              <div class="nav-icon"><i class="bi bi-clipboard-data"></i></div>
              <span class="nav-text">Presupuesto</span>
              <i class="bi bi-chevron-down nav-arrow"></i>
              <span class="nav-tooltip">Presupuesto</span>
            </a>
          </div>
          <div class="submenu{% if presupuesto_active %} show{% endif %}" id="presupuestoSubmenu">
            <a href="{{ url_for('presupuestos.form_presupuesto') }}" class="nav-link{% if request.path == url_for('presupuestos.form_presupuesto') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-calendar-check"></i></div>
              <span class="nav-text">Planificación</span>
            </a>
            <a href="{{ url_for('gastos_directos.form_gastos_directos') }}" class="nav-link{% if request.path == url_for('gastos_directos.form_gastos_directos') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-receipt"></i></div>
              <span class="nav-text">Gastos Directos</span>
            </a>
            <a href="{{ url_for('estado_presupuesto.show_estado') }}" class="nav-link{% if request.path == url_for('estado_presupuesto.show_estado') %} active{% endif %}">
              <div class="nav-icon"><i class="bi bi-bar-chart"></i></div>
              <span class="nav-text">Estado Presupuesto</span>
            </a>
          </div>
        </div>
      <!-- Footer -->
      <div class="sidebar-footer">
        <!-- Perfil de Usuario -->
        <div class="user-profile">
          <div class="user-avatar" style="background: linear-gradient(135deg, #6d28d9, #6366f1);">
            {% if current_user.is_authenticated and current_user.nombre %}
              {{ current_user.nombre[:2].upper() }}
            {% else %}
              <i class="bi bi-person"></i>
            {% endif %}
          </div>
          <div class="user-info">
            <div class="user-name">
              {% if current_user.is_authenticated and current_user.nombre %}
                {{ current_user.nombre }}
              {% else %}
                Usuario
              {% endif %}
            </div>
            <div class="user-role">SOMYL <span style="color:#9ca3af; font-size:0.95em;">v1.0.0</span></div>
          </div>
        </div>

        <!-- Estado de Pagos (dinámico) -->
        <div class="payment-status">
          <div class="payment-label">Pendiente por pagar</div>
          <div class="payment-amount">${{ "{:,.0f}".format(total_pendiente) }}</div>
        </div>

        <!-- Botón de Cerrar Sesión -->
        <a href="{{ url_for('auth.logout') }}" class="logout-btn">
          <i class="bi bi-box-arrow-right"></i>
          <span class="logout-text">Cerrar sesión</span>
        </a>
      </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="content">
      <div class="container-glass">
        {% block content %}{% endblock %}
      </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Toggle sidebar colapsado (mejorado: siempre alterna)
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebarToggleBtn').querySelector('i');
        const isCollapsed = sidebar.classList.contains('collapsed');
        if (isCollapsed) {
          sidebar.classList.remove('collapsed');
          toggleBtn.className = 'bi bi-chevron-left';
        } else {
          sidebar.classList.add('collapsed');
          toggleBtn.className = 'bi bi-chevron-right';
        }
        // Mover el botón según el estado
        updateToggleBtnPosition();
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed') ? 'true' : 'false');
      }

      function updateToggleBtnPosition() {
        const sidebar = document.getElementById('sidebar');
        const btn = document.getElementById('sidebarToggleBtn');
        if (sidebar.classList.contains('collapsed')) {
          btn.style.left = '58px'; // var(--sidebar-collapsed) - 12px
        } else {
          btn.style.left = '268px'; // var(--sidebar-width) - 12px
        }
      }

      // Toggle sidebar móvil
      function toggleMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        
        sidebar.classList.toggle('mobile-open');
        overlay.classList.toggle('show');
      }

      function closeMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
      }

      // Manejar submenús
      document.addEventListener('DOMContentLoaded', function() {
        // Restaurar estado del sidebar
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (isCollapsed) {
          document.getElementById('sidebar').classList.add('collapsed');
          document.getElementById('sidebarToggleBtn').querySelector('i').className = 'bi bi-chevron-right';
        }
        updateToggleBtnPosition();

        // Toggle real: si está abierto lo cierra, si está cerrado lo abre y cierra los demás
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(element) {
          element.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            if (isExpanded) {
              // Si ya está abierto, ciérralo
              target.classList.remove('show');
              this.setAttribute('aria-expanded', 'false');
              return;
            }
            // Si estaba cerrado, cierra todos los demás y abre este
            document.querySelectorAll('.submenu').forEach(function(submenu) {
              submenu.classList.remove('show');
              const parentLink = document.querySelector(`[data-bs-target="#${submenu.id}"]`);
              if (parentLink) {
                parentLink.setAttribute('aria-expanded', 'false');
              }
            });
            target.classList.add('show');
            this.setAttribute('aria-expanded', 'true');
          });
        });
        
        // Auto-cerrar sidebar móvil al hacer click en enlaces
        document.querySelectorAll('.nav-link:not([data-bs-toggle])').forEach(function(link) {
          link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
              closeMobileSidebar();
            }
          });
        });

        // Cerrar sidebar móvil al redimensionar
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768) {
            closeMobileSidebar();
          }
        });

        // Smooth scrolling para navegación
        document.querySelectorAll('.nav-link[href^="#"]').forEach(function(link) {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            // Aquí puedes agregar lógica de navegación smooth
          });
        });

        // Tooltips para modo colapsado
        if (window.innerWidth > 768) {
          const sidebar = document.getElementById('sidebar');
          
          sidebar.addEventListener('mouseenter', function() {
            if (this.classList.contains('collapsed')) {
              document.querySelectorAll('.nav-tooltip').forEach(function(tooltip) {
                tooltip.style.display = 'block';
              });
            }
          });
          
          sidebar.addEventListener('mouseleave', function() {
            document.querySelectorAll('.nav-tooltip').forEach(function(tooltip) {
              tooltip.style.display = 'none';
            });
          });
        }

        // Animación de entrada escalonada para elementos del nav
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(function(item, index) {
          item.style.opacity = '0';
          item.style.transform = 'translateX(-20px)';
          
          setTimeout(function() {
            item.style.transition = 'all 0.3s ease-out';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
          }, index * 50);
        });

        // Efecto hover mejorado para nav-links
        document.querySelectorAll('.nav-link').forEach(function(link) {
          link.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(4px)';
          });
          
          link.addEventListener('mouseleave', function() {
            if (!this.classList.contains('active')) {
              this.style.transform = 'translateX(0)';
            }
          });
        });

        // Actualizar badges dinámicamente (ejemplo)
        function updateBadges() {
          // Simular actualización de badges
          const badge = document.querySelector('.nav-badge');
          if (badge) {
            const count = Math.floor(Math.random() * 10) + 1;
            badge.textContent = count;
            
            // Animación de pulso para nuevas notificaciones
            badge.style.animation = 'pulse 0.6s ease-out';
            setTimeout(() => {
              badge.style.animation = '';
            }, 600);
          }
        }

        // Actualizar badges cada 30 segundos (ejemplo)
        setInterval(updateBadges, 30000);

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
          // Esc para cerrar sidebar móvil
          if (e.key === 'Escape' && window.innerWidth <= 768) {
            closeMobileSidebar();
          }
          
          // Ctrl + B para toggle sidebar en desktop
          if (e.ctrlKey && e.key === 'b' && window.innerWidth > 768) {
            e.preventDefault();
            toggleSidebar();
          }
        });

        // Mejorar accesibilidad
        document.querySelectorAll('.nav-link').forEach(function(link) {
          link.addEventListener('focus', function() {
            this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          });
        });

        // Loading state para enlaces de navegación
        document.querySelectorAll('.nav-link:not([data-bs-toggle])').forEach(function(link) {
          link.addEventListener('click', function() {
            // Mostrar estado de carga
            const icon = this.querySelector('.nav-icon i');
            const originalClass = icon.className;
            
            icon.className = 'bi bi-arrow-clockwise';
            icon.style.animation = 'spin 1s linear infinite';
            
            // Simular carga (en producción esto sería la navegación real)
            setTimeout(function() {
              icon.className = originalClass;
              icon.style.animation = '';
            }, 1000);
          });
        });
      });

      // Utilidad para mostrar notificaciones toast
      function showToast(message, type = 'info') {
        // Esta función se puede integrar con tu sistema de toast existente
        console.log(`${type.toUpperCase()}: ${message}`);
      }

      // Función para destacar enlace activo dinámicamente
      function setActiveLink(href) {
        document.querySelectorAll('.nav-link').forEach(function(link) {
          link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`.nav-link[href="${href}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
          
          // Si está en un submenú, abrir el submenú padre
          const submenu = activeLink.closest('.submenu');
          if (submenu) {
            submenu.classList.add('show');
            const parentLink = document.querySelector(`[data-bs-target="#${submenu.id}"]`);
            if (parentLink) {
              parentLink.setAttribute('aria-expanded', 'true');
            }
          }
        }
      }

      // CSS dinámico para animación de spin
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.1); }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>