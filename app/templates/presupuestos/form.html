{% extends "base.html" %}
{% block title %}Ingreso de Presupuestos - SOMYL{% endblock %}

{% block content %}
<style>
  /* Estilos modernos para el m√≥dulo de presupuestos */
  .presupuesto-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .presupuesto-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem 2rem;
    margin: -1px -1px 0 -1px;
  }

  .presupuesto-header h3 {
    margin: 0;
    font-weight: 600;
    font-size: 1.4rem;
  }

  .presupuesto-header .subtitle {
    opacity: 0.9;
    font-size: 0.9rem;
    margin-top: 0.25rem;
  }

  .form-floating-modern {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .form-floating-modern .form-control,
  .form-floating-modern .form-select {
    height: 58px;
    padding-top: 1.625rem;
    padding-bottom: 0.625rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-floating-modern .form-control:focus,
  .form-floating-modern .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
  }

  .form-floating-modern label {
    position: absolute;
    top: 0;
    left: 0;
    padding: 1rem 0.75rem 0.25rem;
    color: #6b7280;
    font-weight: 500;
    font-size: 0.875rem;
    pointer-events: none;
    transform-origin: 0 0;
    transition: all 0.15s ease-in-out;
  }

  .btn-modern {
    border-radius: 12px;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
  }

  .btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s ease;
  }

  .btn-modern:hover::before {
    left: 100%;
  }

  .btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .btn-primary-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-success-modern {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }

  .btn-outline-modern {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #e2e8f0;
    color: #374151;
  }

  .btn-outline-modern:hover {
    border-color: #667eea;
    color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }

  /* Tabla de gastos ingresados */
  .gastos-table-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-top: 2rem;
    border: 1px solid #e2e8f0;
  }

  .gastos-table-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .gastos-table-header h4 {
    margin: 0;
    color: #374151;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .gastos-table {
    width: 100%;
    font-size: 0.9rem;
  }

  .gastos-table th {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    color: #374151;
    font-weight: 600;
    padding: 0.75rem;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .gastos-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
  }

  .gastos-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.03);
  }

  .editable-cell {
    background: transparent;
    border: 1px solid transparent;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    width: 100%;
  }

  .editable-cell:hover {
    border-color: #e2e8f0;
    background: rgba(102, 126, 234, 0.03);
  }

  .editable-cell:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    outline: none;
    background: white;
  }

  .delete-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .delete-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  /* Loading states */
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    border-radius: 15px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f4f6;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Stats cards */
  .stats-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
  }

  .stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .stats-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 0.25rem;
  }

  .stats-label {
    font-size: 0.8rem;
    color: #6b7280;
    font-weight: 500;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .presupuesto-container {
      margin: 0 -1rem;
      border-radius: 15px;
    }

    .presupuesto-header {
      padding: 1rem 1.5rem;
    }

    .gastos-table {
      font-size: 0.8rem;
    }

    .gastos-table th,
    .gastos-table td {
      padding: 0.5rem;
    }
  }
</style>

<!-- Header con t√≠tulo -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="titulo-modulo titulo-modulo-con-icono mb-0">
    <span class="icono-modulo">üìä</span>
    Ingreso de Presupuestos
  </h1>
</div>

<!-- Stats cards -->
<div class="row mb-4" id="statsCards" style="display: none;">
  <div class="col-md-3">
    <div class="stats-card">
      <div class="stats-value" id="totalEntries">0</div>
      <div class="stats-label">Total Registros</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stats-card">
      <div class="stats-value" id="totalAmount">$0</div>
      <div class="stats-label">Monto Total</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stats-card">
      <div class="stats-value" id="uniqueItems">0</div>
      <div class="stats-label">√çtems √önicos</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stats-card">
      <div class="stats-value" id="lastEntry">-</div>
      <div class="stats-label">√öltimo Registro</div>
    </div>
  </div>
</div>

<!-- Formulario principal -->
<div class="presupuesto-container">
  <div class="presupuesto-header">
    <h3>Nuevo Registro de Presupuesto</h3>
    <div class="subtitle">Ingrese los datos del presupuesto para el proyecto seleccionado</div>
  </div>

  <div class="p-4">
    <!-- Botones de acci√≥n superior -->
    <div class="row mb-4">
      <div class="col-md-6">
        <a href="{{ url_for('presupuestos.descargar_plantilla') }}" 
           class="btn btn-outline-modern btn-modern me-2">
          <i class="bi bi-download me-2"></i>Descargar Plantilla
        </a>
        <button type="button" class="btn btn-outline-modern btn-modern" data-bs-toggle="modal" data-bs-target="#importModal">
          <i class="bi bi-upload me-2"></i>Importar Excel
        </button>
      </div>
      <div class="col-md-6 text-end">
        <button type="button" class="btn btn-outline-modern btn-modern" onclick="limpiarFormulario()">
          <i class="bi bi-arrow-clockwise me-2"></i>Limpiar
        </button>
      </div>
    </div>

    <!-- Formulario -->
    <form method="POST" id="presupuestoForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-floating-modern">
            <select name="proyecto" id="proyecto" class="form-select" required>
              <option value="">Seleccione un proyecto...</option>
              {% for p in proyectos %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <label for="proyecto">Proyecto *</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating-modern">
            <select name="item" id="item" class="form-select" required>
              <option value="">Seleccione un √≠tem...</option>
              {% for i in items %}
                <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
            <label for="item">√çtem *</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <div class="form-floating-modern">
            <input type="text" name="detalle" id="detalle" class="form-control" maxlength="200" 
                   placeholder="Descripci√≥n detallada del gasto...">
            <label for="detalle">Detalle</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-floating-modern">
            <input type="date" name="fecha" id="fecha" class="form-control" required value="{{ hoy }}">
            <label for="fecha">Fecha *</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="form-floating-modern">
            <input type="number" name="monto" id="monto" class="form-control" min="1" required 
                   placeholder="0" step="1">
            <label for="monto">Monto (CLP) *</label>
          </div>
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <button type="submit" class="btn btn-success-modern btn-modern w-100">
            <i class="bi bi-check-circle me-2"></i>Guardar Presupuesto
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Tabla de gastos ingresados por proyecto -->
<div class="gastos-table-container" id="gastosContainer" style="display: none;">
  <div class="gastos-table-header">
    <h4>Gastos Ingresados del Proyecto: <span id="proyectoSeleccionado">-</span></h4>
  </div>
  
  <div class="table-responsive">
    <table class="gastos-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>√çtem</th>
          <th>Detalle</th>
          <th>Monto (CLP)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="gastosTableBody">
        <!-- Se llenar√° din√°micamente -->
      </tbody>
      <tfoot>
        <tr style="background: #f8fafc; font-weight: 600;">
          <td colspan="3" style="text-align: right; padding-right: 1rem;">Total:</td>
          <td id="totalMonto">$0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
  
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner"></div>
  </div>
</div>

<!-- Modal de importaci√≥n -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Importar Presupuesto desde Excel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('presupuestos.importar_presupuesto') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label for="archivo" class="form-label">Archivo Excel (.xlsx)</label>
            <input type="file" name="archivo" id="archivo" class="form-control" accept=".xlsx" required>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Formato requerido:</strong> El archivo debe contener las columnas: proyecto, item, detalle, fecha, monto
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary-modern btn-modern">
            <i class="bi bi-upload me-2"></i>Importar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<script>
document.addEventListener('DOMContentLoaded', function() {
  const proyectoSelect = document.getElementById('proyecto');
  const gastosContainer = document.getElementById('gastosContainer');
  const statsCards = document.getElementById('statsCards');
  const loadingOverlay = document.getElementById('loadingOverlay');
  
  // Evento de cambio de proyecto
  proyectoSelect.addEventListener('change', function() {
    const proyecto = this.value;
    if (proyecto) {
      document.getElementById('proyectoSeleccionado').textContent = proyecto;
      cargarGastosProyecto(proyecto);
      gastosContainer.style.display = 'block';
      statsCards.style.display = 'flex';
    } else {
      gastosContainer.style.display = 'none';
      statsCards.style.display = 'none';
  const submitBtn = form.querySelector('button[type="submit"]');
  let isSubmitting = false;
    }
  });

  // Funci√≥n para cargar gastos del proyecto
  function cargarGastosProyecto(proyecto) {
    loadingOverlay.style.display = 'flex';
    
    fetch(`/presupuestos/gastos_proyecto?proyecto=${encodeURIComponent(proyecto)}`)
      .then(response => response.json())
      .then(data => {
        actualizarTablaGastos(data.gastos);
        actualizarEstadisticas(data.stats);
      })
      .catch(error => {
    if (isSubmitting) {
      e.preventDefault();
      return;
    }
    isSubmitting = true;
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    }
        console.error('Error:', error);
        mostrarAlerta('Error al cargar los gastos del proyecto', 'error');
      })
      .finally(() => {
        loadingOverlay.style.display = 'none';
      });
  }

  // Funci√≥n para actualizar la tabla de gastos
  function actualizarTablaGastos(gastos) {
    const tbody = document.getElementById('gastosTableBody');
    const totalMonto = document.getElementById('totalMonto');
    tbody.innerHTML = '';
    let total = 0;
    gastos.forEach(gasto => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <input type="date" value="${gasto.fecha}" class="editable-cell" onchange="actualizarGasto(${gasto.id}, 'fecha', this.value)">
        </td>
        <td>
          <select class="editable-cell" onchange="actualizarGasto(${gasto.id}, 'item', this.value)">
            {% for i in items %}
            <option value="{{ i }}" ${gasto.item === '{{ i }}' ? 'selected' : ''}>{{ i }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <input type="text" value="${gasto.detalle || ''}" class="editable-cell" onchange="actualizarGasto(${gasto.id}, 'detalle', this.value)" maxlength="200">
        </td>
        <td>
          <input type="number" value="${gasto.monto}" class="editable-cell" onchange="actualizarGasto(${gasto.id}, 'monto', this.value)" min="1" step="1">
        </td>
        <td>
          <button class="delete-btn" onclick="eliminarGasto(${gasto.id})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
      total += parseInt(gasto.monto) || 0;
    });
    totalMonto.textContent = formatearMonto(total);
  }

  // Funci√≥n para actualizar estad√≠sticas
  function actualizarEstadisticas(stats) {
    document.getElementById('totalEntries').textContent = stats.total_entries;
    document.getElementById('totalAmount').textContent = formatearMonto(stats.total_amount);
    document.getElementById('uniqueItems').textContent = stats.unique_items;
    document.getElementById('lastEntry').textContent = stats.last_entry || '-';
  }

  // Funci√≥n para actualizar un gasto espec√≠fico
  window.actualizarGasto = function(gastoId, campo, valor) {
    fetch('/presupuestos/actualizar_gasto', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        id: gastoId,
        campo: campo,
        valor: valor
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarAlerta('Gasto actualizado correctamente', 'success');
        // Recargar gastos para actualizar el total
        const proyecto = document.getElementById('proyecto').value;
        if (proyecto) {
          cargarGastosProyecto(proyecto);
        }
      } else {
        mostrarAlerta('Error al actualizar el gasto', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarAlerta('Error al actualizar el gasto', 'error');
    });
  };

  // Funci√≥n para eliminar un gasto
  window.eliminarGasto = function(gastoId) {
    if (confirm('¬øEst√° seguro de que desea eliminar este registro?')) {
      fetch('/presupuestos/eliminar_gasto', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: gastoId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          mostrarAlerta('Gasto eliminado correctamente', 'success');
          // Recargar gastos
          const proyecto = document.getElementById('proyecto').value;
          if (proyecto) {
            cargarGastosProyecto(proyecto);
          }
        } else {
          mostrarAlerta('Error al eliminar el gasto', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('Error al eliminar el gasto', 'error');
      });
    }
  };

  // Funci√≥n para limpiar el formulario
  window.limpiarFormulario = function() {
    document.getElementById('presupuestoForm').reset();
    document.getElementById('fecha').value = '{{ hoy }}';
    gastosContainer.style.display = 'none';
    statsCards.style.display = 'none';
  };

  // Funci√≥n para formatear montos
  function formatearMonto(monto) {
    return new Intl.NumberFormat('es-CL', {
      style: 'currency',
      currency: 'CLP',
      minimumFractionDigits: 0
    }).format(monto);
  }

  // Funci√≥n para mostrar alertas
  function mostrarAlerta(mensaje, tipo) {
    const alertContainer = document.getElementById('flash-container');
    const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
    const icon = tipo === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass}`;
    alert.innerHTML = `
      <i class="${icon} me-2"></i>${mensaje}
    `;
    
    alertContainer.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  // Validaciones del formulario
  const form = document.getElementById('presupuestoForm');
  form.addEventListener('submit', function(e) {
    const proyecto = document.getElementById('proyecto').value;
    const item = document.getElementById('item').value;
    const monto = document.getElementById('monto').value;
    
    if (!proyecto || !item || !monto) {
      e.preventDefault();
      mostrarAlerta('Por favor complete todos los campos obligatorios', 'error');
      return;
    }
    
    if (parseInt(monto) <= 0) {
      e.preventDefault();
      mostrarAlerta('El monto debe ser mayor a cero', 'error');
      return;
    }
  });

  // Formateo autom√°tico de monto
  const montoInput = document.getElementById('monto');
  montoInput.addEventListener('input', function() {
    // Formatear el n√∫mero mientras se escribe
    let value = this.value.replace(/\D/g, '');
    if (value) {
      this.value = parseInt(value);
    }
  });

  // Inicializaci√≥n de Select2
  if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js';
    script.onload = function() {
      inicializarSelect2();
    };
    document.body.appendChild(script);
  } else {
    inicializarSelect2();
  }
  function inicializarSelect2() {
    $('#proyecto').select2({
      width: '100%',
      placeholder: 'Seleccione un proyecto...',
      allowClear: true
    });
    $('#item').select2({
      width: '100%',
      placeholder: 'Seleccione un √≠tem...',
      allowClear: true
    });
  }
});
</script>

{% endblock %}