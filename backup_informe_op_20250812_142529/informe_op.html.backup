{% extends 'base.html' %}

{% block title %}Informe de Órdenes de Pago - SOMYL{% endblock %}

{% block content %}

<!-- Modal para historial de abonos -->
<div class="modal fade" id="abonosModal" tabindex="-1" aria-labelledby="abonosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="abonosModalLabel">Historial de Abonos - OP <span id="modalOrdenNum"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formAbono" class="row g-2 mb-3" onsubmit="return registrarAbono(event)">
          <input type="hidden" id="abonoOrdenNum" name="orden_numero">
          <div class="col-md-3">
            <input type="date" class="form-control form-control-sm" id="abonoFecha" name="fecha_abono" required value="{{ date.today().isoformat() }}">
          </div>
          <div class="col-md-3">
            <input type="number" class="form-control form-control-sm" id="abonoMonto" name="monto_abono" min="1" step="any" placeholder="Monto abono" required>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control form-control-sm" id="abonoObs" name="observacion" maxlength="100" placeholder="Observación">
          </div>
          <div class="col-md-2">
            <button type="submit" id="btnRegistrarAbono" class="btn btn-success btn-sm w-100">Registrar abono</button>
          </div>
        </form>
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Monto</th>
              <th>Observación</th>
              <th>Usuario</th>
              <th>Registrado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="abonosTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Header Section -->
<div class="container-fluid px-2 px-md-3 px-lg-2 py-4">
  <!-- Filtros Compactos -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body py-3">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-lg-3 col-md-4">
          <label class="form-label text-muted small fw-semibold mb-1">Búsqueda General</label>
          <input type="text" name="proveedor" class="form-control form-control-sm" 
                 placeholder="Proveedor, detalle, factura, proyecto, N° orden..." 
                 value="{{ filtros_activos.proveedor or '' }}">
        </div>
        
        <div class="col-lg-2 col-md-3">
          <label class="form-label text-muted small fw-semibold mb-1">Proyecto</label>
          <select name="proyecto" class="form-select form-select-sm">
            <option value="">Todos los proyectos</option>
            {% for proyecto in proyectos_unicos %}
            <option value="{{ proyecto }}" {{ 'selected' if filtros_activos.proyecto == proyecto else '' }}>
              {{ proyecto }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-lg-2 col-md-3">
          <label class="form-label text-muted small fw-semibold mb-1">Estado</label>
          <select name="estado" class="form-select form-select-sm">
            <option value="">Todos</option>
            <option value="pagado" {{ 'selected' if filtros_activos.estado == 'pagado' else '' }}>Pagado</option>
            <option value="pendiente" {{ 'selected' if filtros_activos.estado == 'pendiente' else '' }}>Pendiente</option>
            <option value="abono" {{ 'selected' if filtros_activos.estado == 'abono' else '' }}>Con Abonos</option>
          </select>
        </div>
        
        <div class="col-lg-2 col-md-3">
          <label class="form-label text-muted small fw-semibold mb-1">Fecha Desde</label>
          <input type="date" name="fecha_desde" class="form-control form-control-sm" 
                 value="{{ filtros_activos.fecha_desde or '' }}">
        </div>
        
        <div class="col-lg-2 col-md-3">
          <label class="form-label text-muted small fw-semibold mb-1">Fecha Hasta</label>
          <input type="date" name="fecha_hasta" class="form-control form-control-sm" 
                 value="{{ filtros_activos.fecha_hasta or '' }}">
        </div>
        
        <div class="col-lg-1 col-md-2">
          <div class="d-flex gap-1">
            <button type="submit" class="btn btn-primary btn-sm px-3" title="Aplicar Filtros">
              <i class="fas fa-search me-1"></i>Filtrar
            </button>
            <a href="{{ url_for('informe_op.informe_op') }}" class="btn btn-outline-secondary btn-sm px-2" title="Limpiar Filtros">
              <i class="fas fa-times"></i>
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-start mb-4">
    <div class="flex-grow-1">
      <h1 class="h3 mb-0 text-gray-800 fw-bold">Informe de Órdenes de Pago</h1>
      <p class="text-muted mb-0">Gestión completa de pagos y abonos a proveedores</p>
    </div>
    
    <!-- Widget de Saldos por Proyecto -->
    {% if saldos_por_proyecto and saldos_por_proyecto|length > 0 %}
    <div class="ms-4">
      <div class="card border-0 shadow-sm" style="min-width: 300px; max-width: 380px;">
        <div class="card-header bg-danger text-white py-2 px-3 d-flex align-items-center justify-content-between">
          <h6 class="mb-0 fw-semibold d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span class="d-none d-lg-inline">Proyectos Pendientes</span>
            <span class="d-lg-none">Pendientes</span>
          </h6>
          <small class="text-white-50">{{ saldos_por_proyecto|length }} proyecto{% if saldos_por_proyecto|length != 1 %}s{% endif %}</small>
        </div>
        <div class="card-body p-0" style="max-height: 280px; overflow-y: auto;">
          {% for proyecto, saldo in saldos_por_proyecto %}
          <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom hover-bg-light">
            <div class="text-truncate me-2" style="font-size: 0.75rem; font-weight: 500;" title="{{ proyecto }}">
              {{ proyecto[:30] }}{% if proyecto|length > 30 %}...{% endif %}
            </div>
            <div class="text-danger fw-bold" style="font-size: 0.8rem;">
              ${{ "{:,.0f}".format(saldo) }}
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="card-footer bg-light py-2 px-3">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted fw-semibold">Total Pendiente:</small>
            <small class="text-danger fw-bold">${{ "{:,.0f}".format(saldos_por_proyecto|sum(attribute='1')) }}</small>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Formulario principal con tabla -->
  <div class="card border-0 shadow-sm">
    <!-- Solo actualizar fechas de la página actual, pero el backend procesará todo correctamente -->
    <form method="POST" action="{{ url_for('informe_op.update_pagos') }}" id="formPagos">
      
      <!-- Paginación Superior -->
      {% if total_pages > 1 %}
      <div class="card-header bg-white border-bottom py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            Mostrando {{ ((page-1) * per_page + 1) }} - {{ (page * per_page if page * per_page < total_registros else total_registros) }} de {{ total_registros }} registros
          </div>
          
          <nav aria-label="Paginación Superior">
            <ul class="pagination pagination-sm mb-0">
              {% if has_prev %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page-1 }}&per_page={{ per_page }}{% for key, value in request.args.items() %}{% if key not in ['page', 'per_page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                  <i class="fas fa-chevron-left"></i>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-chevron-left"></i></span>
              </li>
              {% endif %}
              
              {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <li class="page-item active">
                  <span class="page-link">{{ p }}</span>
                </li>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}{% for key, value in request.args.items() %}{% if key not in ['page', 'per_page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ p }}</a>
                </li>
                {% elif p == 4 or p == total_pages - 3 %}
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
                {% endif %}
              {% endfor %}
              
              {% if has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page+1 }}&per_page={{ per_page }}{% for key, value in request.args.items() %}{% if key not in ['page', 'per_page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                  <i class="fas fa-chevron-right"></i>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-chevron-right"></i></span>
              </li>
              {% endif %}
            </ul>
          </nav>
          
          <div class="d-flex align-items-center">
            <label class="form-label text-muted small me-2 mb-0">Por página:</label>
            <select class="form-select form-select-sm" style="width: auto;" onchange="changePage(this.value)">
              <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
              <option value="250" {{ 'selected' if per_page == 250 else '' }}>250</option>
              <option value="500" {{ 'selected' if per_page == 500 else '' }}>500</option>
              <option value="1000" {{ 'selected' if per_page == 1000 else '' }}>1000</option>
              <option value="{{ total_registros }}" {{ 'selected' if per_page >= total_registros else '' }}>Todos</option>
            </select>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Botones de acción -->
      <div class="card-header bg-white border-bottom py-3">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          {% if puede_editar %}
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-floppy me-2"></i>Guardar Fechas de Pago
          </button>
          {% endif %}
          <button type="button" class="btn btn-success btn-sm" onclick="exportarFiltrados()">
            <i class="bi bi-file-earmark-excel me-2"></i>Exportar a Excel
          </button>
          
          <!-- Cuadro informativo de Total Saldo Pendiente -->
          <div class="card border-warning bg-warning bg-opacity-10 shadow-sm" style="min-width: 200px;">
            <div class="card-body py-2 px-3">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h6 class="card-title mb-0 text-warning fw-bold" style="font-size: 0.8rem;">
                    <i class="fas fa-exclamation-circle me-1"></i>Total Pendiente
                  </h6>
                  <p class="card-text mb-0 text-muted" style="font-size: 0.7rem;">
                    Filtros aplicados
                  </p>
                </div>
                <div class="text-end">
                  <div class="text-danger fw-bold" style="font-size: 1.1rem; font-family: 'Courier New', monospace;">
                    ${{ "{:,.0f}".format(total_pendiente) }}
                  </div>
                  <small class="text-muted" style="font-size: 0.65rem;">
                    {{ total_pendientes }} registro{% if total_pendientes != 1 %}s{% endif %}
                  </small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="ms-auto d-flex align-items-center">
            <span class="badge bg-light text-dark me-2">
              <span class="stats-indicator stats-paid"></span>
              {{ total_pagados }} Pagados
            </span>
            <span class="badge bg-light text-dark me-2">
              <span class="stats-indicator stats-pending"></span>
              {{ total_pendientes }} Pendientes
            </span>
            <span class="badge bg-primary text-white">
              Página {{ page }}/{{ total_pages }} ({{ total_registros }} total)
            </span>
          </div>
        </div>
      </div>

      <!-- Tabla responsiva con headers fijos -->
      <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-hover mb-0" style="position: relative;">
          <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
            <tr>
              <th class="text-center">ORDEN N°</th>
              <th>FECHA OP</th>
              <th>PROVEEDOR</th>
              <th>RUT</th>
              <th>DETALLE</th>
              <th>FACTURA</th>
              <th class="text-center">FAC. PAGO</th>
              <th class="text-end">TOTAL</th>
              <th class="text-end">ABONADO</th>
              <th class="text-end">SALDO PENDIENTE</th>
              <th class="text-center">HISTORIAL</th>
              <th class="text-center">FECHA PAGO</th>
              <th>PROYECTO</th>
              <th>ITEM(S)</th>
              <th>O.COMPRA</th>
              <th>CONDICIÓN</th>
              <th>VENCIMIENTO</th>
              <th>FECHA FAC.</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pagos %}
            {% set estado_pago = "pendiente" %}
            {% if p.fecha_pago %}
                {% set estado_pago = "pagado" %}
            {% elif p.total_abonado > 0 and p.saldo_pendiente > 0 %}
                {% set estado_pago = "abono" %}
            {% endif %}
            <tr class="{% if estado_pago == 'pagado' %}table-success{% elif estado_pago == 'abono' %}table-warning{% endif %}" 
                data-orden="{{ p.orden_numero }}" data-estado="{{ estado_pago }}">
              <!-- Orden N° -->
              <td class="text-center">
                <strong class="badge bg-primary">{{ p.orden_numero }}</strong>
                <input type="hidden" name="orden_numero[]" value="{{ p.orden_numero }}">
              </td>
              
              <!-- Fecha OP -->
              <td class="small text-muted">{{ p.fecha }}</td>
              
              <!-- Proveedor -->
              <td class="text-truncate" title="{{ p.proveedor_nombre }}">
                <strong>{{ p.proveedor_nombre }}</strong>
              </td>
              
              <!-- RUT -->
              <td class="small">{{ p.rut_proveedor }}</td>
              
              <!-- Detalle -->
              <td class="text-truncate" title="{{ p.detalle_compra }}">
                {{ p.detalle_compra }}
              </td>
              
              <!-- Factura -->
              <td>
                {% if p.factura %}
                  <span class="badge bg-info">{{ p.factura }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              
              <!-- FAC. PAGO -->
              <td class="text-center">
                {% if p.fac_pago == 'SI' %}
                  <span class="badge bg-success">SI</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              
              <!-- Total -->
              <td class="text-end">
                <strong class="text-success">
                  {% if p.total_pago %}
                    ${{ "{:,.0f}".format(p.total_pago).replace(',', '.') }}
                  {% else %}
                    $0
                  {% endif %}
                </strong>
              </td>
              
              <!-- Abonado -->
              <td class="text-end">
                {% if p.total_abonado and p.total_abonado > 0 %}
                  <strong class="text-info">
                    ${{ "{:,.0f}".format(p.total_abonado).replace(',', '.') }}
                  </strong>
                {% else %}
                  <span class="text-muted">$0</span>
                {% endif %}
              </td>
              
              <!-- Saldo Pendiente -->
              <td class="text-end">
                {% if p.saldo_pendiente and p.saldo_pendiente > 0 %}
                  <strong class="text-danger">
                    ${{ "{:,.0f}".format(p.saldo_pendiente).replace(',', '.') }}
                  </strong>
                {% else %}
                  <strong class="text-success">$0</strong>
                {% endif %}
              </td>
              
              <!-- Historial Abonos -->
              <td class="text-center">
                {% if puede_editar %}
                <button type="button" class="btn btn-outline-primary btn-sm" 
                        onclick="showAbonos({{ p.orden_numero }})" title="Ver/Gestionar Abonos">
                  <i class="bi bi-cash-stack"></i>
                </button>
                {% endif %}
              </td>
              
              <!-- Fecha de Pago -->
              <td>
                {% if puede_editar %}
                <input type="date" name="fecha_pago[]" class="form-control form-control-sm" 
                       value="{{ p.fecha_pago or '' }}" max="{{ fecha_maxima }}">
                {% else %}
                  {% if p.fecha_pago %}
                    <span class="badge bg-success">{{ p.fecha_pago }}</span>
                  {% else %}
                    <span class="text-muted">Pendiente</span>
                  {% endif %}
                {% endif %}
              </td>
              
              <!-- Proyecto -->
              <td>
                <span class="badge bg-secondary">{{ p.proyecto }}</span>
              </td>
              
              <!-- Items -->
              <td class="small text-muted">{{ p.item }}</td>
              
              <!-- Orden Compra -->
              <td>
                {% if p.orden_compra %}
                  <span class="badge bg-warning text-dark">{{ p.orden_compra }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              
              <!-- Condición -->
              <td class="small">{{ p.condicion_pago }}</td>
              
              <!-- Vencimiento -->
              <td class="small">
                {% if p.vencimiento %}
                  <span class="text-danger">{{ p.vencimiento }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              
              <!-- Fecha Factura -->
              <td class="small text-muted">{{ p.fecha_factura }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Paginación -->
      {% if total_pages > 1 %}
      <div class="card-footer bg-white border-top py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            Mostrando {{ ((page-1) * per_page + 1) }} - {{ (page * per_page if page * per_page < total_registros else total_registros) }} de {{ total_registros }} registros
          </div>
          
          <nav aria-label="Paginación">
            <ul class="pagination pagination-sm mb-0">
              {% if has_prev %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page-1 }}&per_page={{ per_page }}{% for key, value in request.args.items() %}{% if key not in ['page', 'per_page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                  <i class="fas fa-chevron-left"></i>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-chevron-left"></i></span>
              </li>
              {% endif %}
              
              {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <li class="page-item active">
                  <span class="page-link">{{ p }}</span>
                </li>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}{% for key, value in request.args.items() %}{% if key not in ['page', 'per_page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ p }}</a>
                </li>
                {% elif p == 4 or p == total_pages - 3 %}
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
                {% endif %}
              {% endfor %}
              
              {% if has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page+1 }}&per_page={{ per_page }}{% for key, value in request.args.items() %}{% if key not in ['page', 'per_page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                  <i class="fas fa-chevron-right"></i>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-chevron-right"></i></span>
              </li>
              {% endif %}
            </ul>
          </nav>
          
          <div class="d-flex align-items-center">
            <label class="form-label text-muted small me-2 mb-0">Registros por página:</label>
            <select class="form-select form-select-sm" style="width: auto;" onchange="changePage(this.value)">
              <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
              <option value="250" {{ 'selected' if per_page == 250 else '' }}>250</option>
              <option value="500" {{ 'selected' if per_page == 500 else '' }}>500</option>
              <option value="1000" {{ 'selected' if per_page == 1000 else '' }}>1000</option>
              <option value="{{ total_registros }}" {{ 'selected' if per_page >= total_registros else '' }}>Todos</option>
            </select>
          </div>
        </div>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<!-- JavaScript para gestión de abonos -->
<script>
let abonoEditandoId = null;

function showAbonos(orden_numero) {
  document.getElementById('modalOrdenNum').textContent = orden_numero;
  document.getElementById('abonoOrdenNum').value = orden_numero;
  
  const modalEl = document.getElementById('abonosModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
  
  fetch(`/informe_op/abonos/${orden_numero}`)
    .then(resp => resp.json())
    .then(data => {
      const tableBody = document.getElementById('abonosTableBody');
      tableBody.innerHTML = '';
      
      if (data.success && data.abonos && data.abonos.length > 0) {
        data.abonos.forEach(abono => {
          const row = document.createElement('tr');
          const monto = parseInt(abono.monto_abono || 0);
          const fecha = abono.fecha_abono || '-';
          const obs = (abono.observacion || '').replace(/'/g, '&#39;');
          
          row.innerHTML = `
            <td>${fecha}</td>
            <td>$${monto.toLocaleString('es-CL')}</td>
            <td>${obs}</td>
            <td>${abono.usuario || '-'}</td>
            <td>${abono.created_at ? new Date(abono.created_at).toLocaleDateString('es-CL') : '-'}</td>
            <td>
              <button type="button" class="btn btn-warning btn-sm me-1" onclick="editarAbono(${abono.id}, ${monto}, '${obs}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm" onclick="eliminarAbono(${abono.id}, ${orden_numero})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin abonos registrados</td></tr>';
      }
    })
    .catch(error => {
      console.error('Error al cargar abonos:', error);
      document.getElementById('abonosTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar abonos</td></tr>';
    });
}

function registrarAbono(event) {
  event.preventDefault();
  
  const orden_numero = document.getElementById('abonoOrdenNum').value;
  const fecha = document.getElementById('abonoFecha').value;
  const monto = document.getElementById('abonoMonto').value;
  const obs = document.getElementById('abonoObs').value;
  
  if (!monto || parseFloat(monto) <= 0) {
    alert('El monto debe ser mayor a cero');
    return false;
  }
  
  fetch(`/informe_op/abonos/${orden_numero}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      fecha_abono: fecha,
      monto_abono: monto,
      observacion: obs
    })
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      showAbonos(orden_numero);
      document.getElementById('formAbono').reset();
      document.getElementById('abonoFecha').value = new Date().toISOString().split('T')[0];
      window.needsPageReload = true;
    } else {
      alert('Error: ' + (data.error || 'No se pudo registrar abono.'));
    }
  })
  .catch(error => {
    console.error('Error al registrar abono:', error);
    alert('Error de conexión al registrar el abono.');
  });
  
  return false;
}

function editarAbono(id, monto, observacion) {
  const tableBody = document.getElementById('abonosTableBody');
  const rows = tableBody.querySelectorAll('tr');
  
  rows.forEach(row => {
    const editButton = row.querySelector(`button[onclick*="editarAbono(${id}"]`);
    if (editButton) {
      row.innerHTML = `
        <td><input type="date" id="editFecha" value="" class="form-control form-control-sm"></td>
        <td><input type="number" id="editMonto" value="${monto}" class="form-control form-control-sm" min="1" step="any"></td>
        <td><input type="text" id="editObs" value="${observacion}" class="form-control form-control-sm" maxlength="100"></td>
        <td colspan="2">Editando...</td>
        <td>
          <button type="button" class="btn btn-success btn-sm me-1" onclick="guardarEdicionAbono(${id}, document.getElementById('abonoOrdenNum').value)">
            <i class="bi bi-check"></i>
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="showAbonos(document.getElementById('abonoOrdenNum').value)">
            <i class="bi bi-x"></i>
          </button>
        </td>
      `;
      abonoEditandoId = id;
    }
  });
}

function guardarEdicionAbono(id, orden_numero) {
  const monto = document.getElementById('editMonto').value;
  const obs = document.getElementById('editObs').value;
  
  if (!monto || parseFloat(monto) <= 0) {
    alert('El monto debe ser mayor a cero');
    return;
  }
  
  fetch(`/informe_op/abonos/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ monto_abono: monto, observacion: obs })
  })
  .then(resp => resp.json())
  .then(data => {
    abonoEditandoId = null;
    if (data.success) {
      showAbonos(orden_numero);
      window.needsPageReload = true;
    } else {
      alert('Error: ' + (data.error || 'No se pudo editar abono.'));
    }
  })
  .catch(error => {
    console.error('Error al editar abono:', error);
    alert('Error de conexión al editar el abono.');
    abonoEditandoId = null;
  });
}

function eliminarAbono(id, orden_numero) {
  if (!confirm('¿Seguro que deseas eliminar este abono?')) return;
  
  fetch(`/informe_op/abonos/${id}`, { method: 'DELETE' })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        showAbonos(orden_numero);
        window.needsPageReload = true;
      } else {
        alert('Error: ' + (data.error || 'No se pudo eliminar abono.'));
      }
    })
    .catch(error => {
      console.error('Error al eliminar abono:', error);
      alert('Error de conexión al eliminar el abono.');
    });
}

function exportarFiltrados() {
  const params = new URLSearchParams(window.location.search);
  window.open(`{{ url_for('informe_op.export_informe_op') }}?${params.toString()}`, '_blank');
}

function changePage(newPerPage) {
  const url = new URL(window.location);
  url.searchParams.set('per_page', newPerPage);
  url.searchParams.set('page', '1'); // Resetear a la primera página
  window.location.href = url.toString();
}

// Recargar página al cerrar modal si hay cambios
document.getElementById('abonosModal').addEventListener('hidden.bs.modal', function () {
  if (window.needsPageReload) {
    window.location.reload();
  }
});
</script>

<!-- CSS adicional -->
<style>
.stats-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 5px;
}

.stats-paid {
  background-color: #28a745;
}

.stats-pending {
  background-color: #dc3545;
}

.table td {
  vertical-align: middle;
  font-size: 0.9em;
}

.table th {
  font-size: 0.8em;
  font-weight: 600;
  background-color: #f8f9fa !important;
  border-bottom: 2px solid #dee2e6 !important;
}

.table-responsive {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

/* Mejorar visibilidad del header fijo */
.table thead th {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Optimización de anchos de columnas para mejor aprovechamiento del espacio */
.table th:nth-child(1), .table td:nth-child(1) { width: 80px; min-width: 80px; } /* ORDEN N° */
.table th:nth-child(2), .table td:nth-child(2) { width: 90px; min-width: 90px; } /* FECHA OP */
.table th:nth-child(3), .table td:nth-child(3) { width: 180px; min-width: 150px; } /* PROVEEDOR */
.table th:nth-child(4), .table td:nth-child(4) { width: 110px; min-width: 100px; } /* RUT */
.table th:nth-child(5), .table td:nth-child(5) { width: 200px; min-width: 180px; } /* DETALLE */
.table th:nth-child(6), .table td:nth-child(6) { width: 80px; min-width: 70px; } /* FACTURA */
.table th:nth-child(7), .table td:nth-child(7) { width: 40px; min-width: 40px; } /* FAC. PAGO */
.table th:nth-child(8), .table td:nth-child(8) { width: 110px; min-width: 100px; } /* TOTAL */
.table th:nth-child(9), .table td:nth-child(9) { width: 110px; min-width: 100px; } /* ABONADO */
.table th:nth-child(10), .table td:nth-child(10) { width: 130px; min-width: 120px; } /* SALDO PENDIENTE */
.table th:nth-child(11), .table td:nth-child(11) { width: 70px; min-width: 70px; } /* HISTORIAL */
.table th:nth-child(12), .table td:nth-child(12) { width: 130px; min-width: 120px; } /* FECHA PAGO */
.table th:nth-child(13), .table td:nth-child(13) { width: 80px; min-width: 70px; } /* PROYECTO */
.table th:nth-child(14), .table td:nth-child(14) { width: 60px; min-width: 60px; } /* ITEM(S) */
.table th:nth-child(15), .table td:nth-child(15) { width: 80px; min-width: 70px; } /* O.COMPRA */
.table th:nth-child(16), .table td:nth-child(16) { width: 80px; min-width: 70px; } /* CONDICIÓN */
.table th:nth-child(17), .table td:nth-child(17) { width: 100px; min-width: 90px; } /* VENCIMIENTO */
.table th:nth-child(18), .table td:nth-child(18) { width: 100px; min-width: 90px; } /* FECHA FAC. */

/* Compactar texto y mejorar legibilidad */
.table td {
  padding: 0.5rem 0.3rem;
  font-size: 0.85em;
  line-height: 1.3;
}

.table th {
  padding: 0.6rem 0.3rem;
  font-size: 0.75em;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Texto largo en celdas con ellipsis */
.table td.text-truncate {
  max-width: 1px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Botones más compactos */
.btn-sm {
  padding: 0.2rem 0.4rem;
  font-size: 0.75rem;
}

/* Inputs de fecha más compactos */
.form-control-sm {
  padding: 0.2rem 0.4rem;
  font-size: 0.8rem;
}

/* Optimizar el espacio del contenedor de la tabla */
@media (min-width: 1200px) {
  .table-responsive {
    max-height: 75vh;
  }
}

@media (min-width: 1400px) {
  .table-responsive {
    max-height: 80vh;
  }
}

/* Widget de Saldos por Proyecto - Responsivo */
@media (max-width: 1199px) {
  .d-flex.justify-content-between.align-items-start {
    flex-direction: column !important;
  }
  
  .ms-4 {
    margin-left: 0 !important;
    margin-top: 1rem !important;
    align-self: stretch;
  }
  
  .card {
    min-width: auto !important;
    max-width: none !important;
  }
}

/* Animación suave para el widget */
.card {
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

/* Mejorar la apariencia de los montos */
.text-danger.fw-bold {
  font-family: 'Courier New', monospace;
  letter-spacing: 0.5px;
}

/* Scroll personalizado para el widget */
.card-body::-webkit-scrollbar {
  width: 4px;
}

.card-body::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.card-body::-webkit-scrollbar-thumb {
  background: #dc3545;
  border-radius: 2px;
}

.card-body::-webkit-scrollbar-thumb:hover {
  background: #c82333;
}

/* Efecto hover para los items del widget */
.hover-bg-light:hover {
  background-color: #f8f9fa !important;
  transition: background-color 0.2s ease;
}

/* Estilos para el cuadro de Total Saldo Pendiente */
.card.border-warning {
  border-width: 2px !important;
  transition: all 0.3s ease;
}

.card.border-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3) !important;
}

/* Animación de pulso sutil para el monto */
.text-danger.fw-bold {
  animation: subtle-pulse 3s ease-in-out infinite;
}

@keyframes subtle-pulse {
  0%, 100% { 
    opacity: 1; 
  }
  50% { 
    opacity: 0.8; 
  }
}

/* Responsividad para el cuadro informativo */
@media (max-width: 768px) {
  .card.border-warning {
    min-width: 160px !important;
    font-size: 0.9rem;
  }
  
  .card.border-warning .text-danger.fw-bold {
    font-size: 1rem !important;
  }
}

/* Estilos para filtros compactos */
.card-body .row.g-2 {
  align-items: end;
}

.form-label.mb-1 {
  margin-bottom: 0.25rem !important;
  font-size: 0.75rem;
}

/* Botones de filtro más compactos y elegantes */
.btn-sm.px-3 {
  font-size: 0.8rem;
  padding: 0.375rem 0.75rem;
}

.btn-sm.px-2 {
  padding: 0.375rem 0.5rem;
}
</style>

{% endblock %}