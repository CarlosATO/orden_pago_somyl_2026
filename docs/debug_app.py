#!/usr/bin/env python3
"""
Script de diagn√≥stico para identificar errores en la aplicaci√≥n
"""

import sys
import traceback

def test_basic_imports():
    """Prueba imports b√°sicos"""
    try:
        print("1. Probando import os...")
        import os
        print("‚úÖ os importado correctamente")
        
        print("2. Probando import flask...")
        from flask import Flask
        print("‚úÖ Flask importado correctamente")
        
        print("3. Probando import supabase...")
        from supabase import create_client
        print("‚úÖ Supabase importado correctamente")
        
        print("4. Probando import dotenv...")
        from dotenv import load_dotenv
        print("‚úÖ dotenv importado correctamente")
        
        return True
    except Exception as e:
        print(f"‚ùå Error en imports b√°sicos: {e}")
        traceback.print_exc()
        return False

def test_environment():
    """Prueba variables de entorno"""
    try:
        print("5. Cargando variables de entorno...")
        from dotenv import load_dotenv
        load_dotenv()
        
        import os
        supabase_url = os.getenv('SUPABASE_URL')
        supabase_key = os.getenv('SUPABASE_ANON_KEY')
        
        if supabase_url and supabase_key:
            print("‚úÖ Variables de entorno encontradas")
            print(f"   SUPABASE_URL: {supabase_url[:50]}...")
            print(f"   SUPABASE_ANON_KEY: {supabase_key[:20]}...")
        else:
            print("‚ö†Ô∏è Variables de entorno no encontradas")
            print(f"   SUPABASE_URL: {supabase_url}")
            print(f"   SUPABASE_ANON_KEY: {'Found' if supabase_key else 'Not found'}")
        
        return True
    except Exception as e:
        print(f"‚ùå Error en variables de entorno: {e}")
        traceback.print_exc()
        return False

def test_app_modules():
    """Prueba imports de m√≥dulos de la app"""
    try:
        print("6. Probando import de m√≥dulos de la app...")
        
        # Agregar directorio padre al path para importar app
        import os
        parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        sys.path.insert(0, parent_dir)
        
        print("   - app.modules.usuarios...")
        from app.modules.usuarios import get_modulos_usuario
        print("   ‚úÖ usuarios importado")
        
        print("   - app.utils.cache...")
        from app.utils.cache import cache
        print("   ‚úÖ cache importado")
        
        print("   - app.utils.api_helpers...")
        from app.utils.api_helpers import api_cache
        print("   ‚úÖ api_helpers importado")
        
        return True
    except Exception as e:
        print(f"‚ùå Error en m√≥dulos de la app: {e}")
        traceback.print_exc()
        return False

def test_app_creation():
    """Prueba creaci√≥n de la app"""
    try:
        print("7. Probando creaci√≥n de la app...")
        
        # Agregar directorio padre al path para importar app
        import os
        parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        sys.path.insert(0, parent_dir)
        
        from app import create_app
        
        print("   - Creando app...")
        app = create_app()
        print("   ‚úÖ App creada correctamente")
        
        print("   - Probando configuraci√≥n...")
        with app.app_context():
            print(f"   ‚úÖ App context funciona")
            print(f"   ‚úÖ Debug mode: {app.debug}")
        
        return True
    except Exception as e:
        print(f"‚ùå Error en creaci√≥n de la app: {e}")
        traceback.print_exc()
        return False

def main():
    print("üîç DIAGN√ìSTICO DE LA APLICACI√ìN SOMYL")
    print("=" * 50)
    
    success = True
    
    success &= test_basic_imports()
    success &= test_environment()
    success &= test_app_modules()
    success &= test_app_creation()
    
    print("=" * 50)
    if success:
        print("üéâ DIAGN√ìSTICO COMPLETADO: Todo funciona correctamente")
        print("   El problema puede estar en el entorno de producci√≥n")
    else:
        print("‚ùå DIAGN√ìSTICO FALLIDO: Se encontraron errores")
        print("   Revisar los errores mostrados arriba")
    
    return success

if __name__ == "__main__":
    main()
