#!/usr/bin/env python3
"""
Script de diagn√≥stico para verificar que el backend puede iniciar
"""
import sys
import os
from pathlib import Path

# Agregar el directorio al path
SCRIPT_DIR = Path(__file__).parent.absolute()
sys.path.insert(0, str(SCRIPT_DIR))

print("üîç Diagn√≥stico del Backend\n")
print("="*60)

# 1. Verificar imports
print("\n1Ô∏è‚É£ Verificando imports...")
try:
    from backend.app import create_app
    print("   ‚úÖ backend.app importado correctamente")
except Exception as e:
    print(f"   ‚ùå Error al importar backend.app: {e}")
    sys.exit(1)

# 2. Verificar .env
print("\n2Ô∏è‚É£ Verificando archivo .env...")
env_file = SCRIPT_DIR / ".env"
if env_file.exists():
    print(f"   ‚úÖ Archivo .env encontrado")
    # Verificar variables clave
    from dotenv import load_dotenv
    load_dotenv()
    
    required_vars = ['SUPABASE_URL', 'SUPABASE_KEY', 'SECRET_KEY']
    for var in required_vars:
        if os.environ.get(var):
            print(f"   ‚úÖ {var} est√° definida")
        else:
            print(f"   ‚ö†Ô∏è  {var} NO est√° definida")
else:
    print(f"   ‚ùå Archivo .env NO encontrado en {env_file}")

# 3. Intentar crear la app
print("\n3Ô∏è‚É£ Intentando crear la aplicaci√≥n Flask...")
try:
    app = create_app()
    print("   ‚úÖ Aplicaci√≥n Flask creada exitosamente")
    
    # Listar rutas registradas
    print("\n   üìã Rutas registradas:")
    for rule in app.url_map.iter_rules():
        print(f"      {rule.methods} {rule.rule}")
    
except Exception as e:
    print(f"   ‚ùå Error al crear la aplicaci√≥n: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# 4. Verificar conexi√≥n a Supabase
print("\n4Ô∏è‚É£ Verificando conexi√≥n a Supabase...")
try:
    supabase = app.config.get('SUPABASE')
    if supabase:
        print("   ‚úÖ Cliente Supabase configurado")
        # Probar una consulta simple
        result = supabase.table('usuarios').select('id').limit(1).execute()
        print(f"   ‚úÖ Conexi√≥n a Supabase exitosa (encontrados {len(result.data)} registros en prueba)")
    else:
        print("   ‚ùå Cliente Supabase NO configurado")
except Exception as e:
    print(f"   ‚ö†Ô∏è  Error al probar Supabase: {e}")

print("\n" + "="*60)
print("‚úÖ Diagn√≥stico completado - Backend est√° listo para iniciar")
print("\nPara iniciar el backend, ejecuta:")
print("   python run_backend.py")
